<html>
<head>
<title>Lua 5.1 参考手册|Lua教程</title>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8" /> 
</head>
<body>
<hr>
<h1>Lua 5.1 参考手册</h1>
by Roberto Ierusalimschy, Luiz Henrique de Figueiredo, Waldemar Celes
<p>云风 译 <a href="http://www.codingnow.com" rel="nofollow" target="_blank">www.codingnow.com</a><p>
<p><a href="/ssv/">@ssv</a> | <a href="/appdir/">漏洞目录</a> |  <a href="/ssv/Lua_po_tips">Lua性能优化技巧</a></p>
<small><a href="http://www.lua.org/copyright.html">Copyright</a>&copy; 2006 Lua.org, PUC-Rio.  All rights reserved.</small>
<hr>
<p><h1>1 - <a name="1">介绍</a></h1><p>
Lua 是一个扩展式程序设计语言，它被设计成支持通用的过程式编程，并有相关数据描述的设施。
Lua 也能对面向对象编程，函数式编程，数据驱动式编程提供很好的支持。
它可以作为一个强大、轻量的脚本语言，供任何需要的程序使用。
Lua 以一个用 <em>clean</em> C 写成的库形式提供。（所谓 Clean C ，指的 ANSI C 和 C++ 中共通的一个子集）
<p>
作为一个扩展式语言，Lua 没有 "main" 程序的概念：它只能 <em>嵌入</em> 一个宿主程序中工作，这个宿主程序被称作
<em>embedding program</em> 或简称为 <em>host</em> 。
宿主程序可以通过调用函数执行一小段 Lua 代码，可以读写 Lua 变量，可以注入 C 函数让 Lua 代码调用。
这些扩展的 C 函数，可以大大的扩展了 Lua 可以处理事务的领域，这样就可以订制出各种语言，
而它们共享一个统一的句法格式的框架。
Lua 的官方发布版就包含了一个叫做 <code>lua</code> 的简单的宿主程序，它用 Lua 库提供了一个保证独立的 Lua 解释器。
<p>
Lua 是一个自由软件，它的使用许可决定了对它的使用过程一般没有任何保证。
这份手册中描述的东西的实现，可以在 Lua 的官方网站 <code>www.lua.org</code> 找到，
<p>
跟其它的许多参考手册一样，这份文档有些地方比较枯燥。
关于 Lua 的设计想法的探讨，可以看看 Lua 网站上提供的技术论文。
有关用 Lua 编程的细节介绍，可以读一下 Roberto 的书，<em>Programming in Lua (Second Edition)</em> 。
<h1>2 - <a name="2">语言</a></h1>
<p>
这一节从词法、语法、句法上描述 Lua 。
换句话说，这一节描述了哪些 token （符记）是有效的，它们如何被组合起来，这些组合方式有什么含义。
<p>
关于语言的构成概念将用常见的扩展 BNF 表达式写出。也就是这个样子：
{<em>a</em>} 意思是 0 或多个 <em>a</em> ，
[<em>a</em>] 意思是一个可选的 <em>a</em> 。
非最终的符号会保留原来的样子，关键字则看起来像这样 <b>kword</b> ，
其它最终的符号则写成 `<b>=</b>&acute; 。
完整的 Lua 语法可以在本手册最后找到。
<h2>2.1 - <a name="2.1">词法约定</a></h2>
<p>
Lua 中用到的 <em>名字</em>（也称作 <em>标识符</em>）可以是任何非数字开头的字母、数字、下划线组成的字符串。
这符合几乎所有编程语言中关于名字的定义。
（字母的定义依赖于当前环境：系统环境中定义的字母表中的字母都可以被用于标识符。）
标识符用来命名变量，或作为表的域名。
<p>
下面的关键字是保留的，不能用作名字：
<pre>
     and       break     do        else      elseif
     end       false     for       function  if
     in        local     nil       not       or
     repeat    return    then      true      until     while
</pre>
<p>
Lua 是一个大小写敏感的语言：
<code>and</code> 是一个保留字，但是 <code>And</code> 和 <code>AND</code> 则是两个不同的合法的名字。
一般约定，以下划线开头连接一串大写字母的名字（比如 <code>_VERSION</code>）被保留用于 Lua 内部全局变量。

<p>
下面这些是其它的 token ：

<pre>
     +     -     *     /     %     ^     #
     ==    ~=    &lt;=    &gt;=    &lt;     &gt;     =
     (     )     {     }     [     ]
     ;     :     ,     .     ..    ...

</pre>

<p>
字符串既可以用一对单引号引起，也可以是双引号，里面还可以包含类似 C 的转义符：
'<code>\a</code>' （响铃），
'<code>\b</code>' （退格），
'<code>\f</code>' （表单），
'<code>\n</code>' （换行），
'<code>\r</code>' （回车），
'<code>\t</code>' （横向制表），
'<code>\v</code>' （纵向制表），
'<code>\\</code>' （反斜杠），
'<code>\"</code>' （双引号），
以及 '<code>\'</code>' （单引号)。
而且，如果在一个反斜杠后跟了一个真正的换行符，其结果就是在字符串中产生一个换行符。
我们还可以用反斜杠加数字的形式 <code>\<em>ddd</em></code> 来描述一个字符。这里，

<em>ddd</em> 是一串最多三位的十进制数字。（注意，如果需要在这种描述方法后接一个是数字的字符，
那么反斜杠后必须写满三个数字。）Lua 中的字符串可以包含任何 8 位的值。包括用 '<code>\0</code>' 表示的零。

<p>
只有在你需要把不同的引号、换行、反斜杠、或是零结束符这些字符置入字符串时，
你才必须使用转义符。别的任何字符都可以直接写在文本里。（一些控制符可以会影响文件系统造成某些问题，
但是不会引起 Lua 的任何问题。）

<p>
字符串还可以用一种长括号括起来的方式定义。
我们把两个正的方括号间插入 n 个等号定义为第 n 级正长括号。
就是说，0 级正的长括号写作 <code>[[</code> ，
一级正的长括号写作 <code>[=[</code> ，如此等等。
反的长扩展也作类似定义；
举个例子，4 级反的长括号写作 <code>]====]</code> 。
一个长字符串可以由任何一级的正的长括号开始，而由第一个碰到的同级反的长括号结束。
整个词法分析过程将不受分行限制，不处理任何转意符，并且忽略掉任何不同级别的长括号。
这种方式描述的字符串可以包含任何东西，当然特定级别的反长括号除外。


<p>
另一个约定是，当正的长括号后面立即跟了一个换行符，
这个换行符就不包含在这个字符串内。
举个例子，假设一个系统使用 ASCII 码
（这时，'<code>a</code>' 编码为 97 ，换行符编码为 10 ，'<code>1</code>' 编码为 49 ），
下面五种方式描述了完全相同的字符串：

<pre>
     a = 'alo\n123"'
     a = "alo\n123\""
     a = '\97lo\10\04923"'
     a = [[alo
     123"]]
     a = [==[
     alo
     123"]==]
</pre>

<p>
数字常量可以分两部分写，十进制底数部分和十进制的指数部分。指数部分是可选的。
Lua 也支持十六进制整数常量，只需要在前面加上前缀 <code>0x</code> 。
下面是一些合法的数字常量的例子：

<pre>

     3   3.0   3.1416   314.16e-2   0.31416E1   0xff   0x56
</pre>

<p>
注释可以在除字符串内的任何地方是以两横 (<code>--</code>) 开始。
如果跟在两横后面的不是一个长括号，这就是一个短注释，它的作用范围直到行末；
否则就是一个长注释，其作用范围直到遇到反的长括号。
长注释通常被用来临时屏蔽代码块。

<h2>2.2 - <a name="2.2">值与类型</a></h2>

<p>
Lua 是一种 <em>动态类型语言</em>。
这意味着变量没有类型，只有值才有类型。
语言中不存在类型定义。而所有的值本身携带它们自己的类型信息。

<p>

Lua 中的所有值都是一致 (first-class) 的。
这意味着所有的值都可以被放在变量里，当作参数传递到另一个函数中，并被函数作为结果返回。

<p>
Lua 中有八种基本类型：
<em>nil</em>, <em>boolean</em>, <em>number</em>,
<em>string</em>, <em>function</em>, <em>userdata</em>,
<em>thread</em>, and <em>table</em>.

<em>Nil</em> 类型只有一种值 <b>nil</b> ，它的主要用途用于标表识和别的任何值的差异；
通常，当需要描述一个无意义的值时会用到它。
<em>Boolean</em> 类型只有两种值：<b>false</b> 和 <b>true</b>。
<b>nil</b> 和 <b>false</b> 都能导致条件为假；而另外所有的值都被当作真。

<em>Number</em> 表示实数（双精度浮点数）。
（编译一个其它内部数字类型的 Lua 解释器是件很容易的事；比如把内部数字类型改作
单精度浮点数或长整型。参见文件 <code>luaconf.h</code> 。）
<em>String</em> 表示一串字符的数组。

Lua 是 8-bit clean 的：
字符串可以包含任何 8 位字符，
包括零结束符 ('<code>\0</code>') （参见 <a href="#2.1">&sect;2.1</a>）。


<p>
Lua 可以调用（和处理）用 Lua 写的函数以及用 C 写的函数（参见 <a href="#2.5.8">&sect;2.5.8</a>）.



<p>
<em>userdata</em> 类型用来将任意 C 数据保存在 Lua 变量中。
这个类型相当于一块原生的内存，除了赋值和相同性判断，Lua 没有为之预定义任何操作。
然而，通过使用 <em>metatable （元表）</em> ，程序员可以为 userdata 自定义一组操作
（参见 <a href="#2.8">&sect;2.8</a>）。
userdata 不能在 Lua 中创建出来，也不能在 Lua 中修改。这样的操作只能通过 C API。
这一点保证了宿主程序完全掌管其中的数据。

<p>
<em>thread</em> 类型用来区别独立的执行线程，它被用来实现 coroutine （协同例程）（参见 <a href="#2.11">&sect;2.11</a>）。
不要把 Lua 线程跟操作系统的线程搞混。
Lua 可以在所有的系统上提供对 coroutine 的支持，即使系统并不支持线程。

<p>
<em>table</em> 类型实现了一个关联数组。也就是说，
数组可以用任何东西（除了<b>nil</b>）做索引，而不限于数字。
table 可以以不同类型的值构成；它可以包含所有的类型的值（除 <b>nil</b> 外）。
table 是 lua 中唯一的一种数据结构；它可以用来描述原始的数组、符号表、集合、
记录、图、树、等等。
用于表述记录时，lua 使用域名作为索引。
语言本身采用一种语法糖，支持以 <code>a.name</code> 的形式表示 <code>a["name"]</code>。
有很多形式用于在 lua 中创建一个 table （参见 <a href="#2.5.7">&sect;2.5.7</a>）。


<p>
跟索引一样， table 每个域中的值也可以是任何类型（除 <b>nil</b>外）。
特别的，因为函数本身也是值，所以 table 的域中也可以放函数。
这样 table 中就可以有一些 <em>methods</em> 了 （参见see <a href="#2.5.9">&sect;2.5.9</a>）。

<p>
table， function ，thread ，和 (full) userdata 这些类型的值是所谓的对象：
变量本身并不会真正的存放它们的值，而只是放了一个对对象的引用。
赋值，参数传递，函数返回，都是对这些对象的引用进行操作；
这些操作不会做暗地里做任何性质的拷贝。

<p>
库函数 <a href="#pdf-type"><code>type</code></a> 可以返回一个描述给定值的类型的字符串。

<h3>2.2.1 - <a name="2.2.1">强制转换</a></h3>

<p>
Lua 提供运行时字符串到数字的自动转换。
任何对字符串的数学运算操作都会尝试用一般的转换规则把这个字符串转换成一个数字。
相反，无论何时，一个数字需要作为字符串来使用时，数字都会以合理的格式转换为字符串。
需要完全控制数字怎样转换为字符串，可以使用字符串库中的 <code>format</code> 函数
（参见 <a href="#pdf-string.format"><code>string.format</code></a>）。


<h2>2.3 - <a name="2.3">变量</a></h2>

<p>
写上变量的地方意味着当以其保存的值来替代之。

Lua 中有三类变量：全局变量，局部变量，还有 table 的域。

<p>
一个单一的名字可以表示一个全局变量，也可以表示一个局部变量 （或者是一个函数的参数，这是一种特殊形式的局部变量）：

<pre>

	var ::= Name
</pre><p>
Name 就是 <a href="#2.1">&sect;2.1</a> 中所定义的标识符。

<p>
任何变量都被假定为全局变量，除非显式的以 local 修饰定义 
（参见 <a href="#2.4.7">&sect;2.4.7</a>）。
局部变量有其作用范围：
局部变量可以被定义在它作用范围中的函数自由使用
（参见 <a href="#2.6">&sect;2.6</a>）。


<p>
在变量的首次赋值之前，变量的值均为 <b>nil</b>。



<p>
方括号被用来对 table 作索引：

<pre>
	var ::= prefixexp `<b>[</b>&acute; exp `<b>]</b>&acute;
</pre><p>
对全局变量以及 table 域之访问的含义可以通过 metatable 来改变。
以取一个变量下标指向的量 <code>t[i]</code> 等价于调用 <code>gettable_event(t,i)</code>。
（参见 <a href="#2.8">&sect;2.8</a> ，有一份完整的关于

<code>gettable_event</code> 函数的说明。
这个函数并没有在 lua 中定义出来，也不能在 lua 中调用。
这里我们把它列出来只是方便说明。）

<p>
<code>var.Name</code> 这种语法只是一个语法糖，用来表示
<code>var["Name"]</code>：

<pre>
	var ::= prefixexp `<b>.</b>&acute; Name
</pre>

<p>
所有的全局变量都是放在一个特定 lua table 的诸个域中，这个特定的 table
叫作 <em>environment （环境）table</em> 或者简称为
<em>环境</em> （参见 <a href="#2.9">&sect;2.9</a>）。
每个函数都有对一个环境的引用，
所以一个函数中可见的所有全局变量都放在这个函数所引用的环境表（environment table）中。
当一个函数被创建出来，它会从创建它的函数中继承其环境，你可以调用
<a href="#pdf-getfenv"><code>getfenv</code></a> 取得其环境。
如果想改变环境，可以调用 <a href="#pdf-setfenv"><code>setfenv</code></a>。
（对于 C 函数，你只能通过 debug 库来改变其环境；
参见 <a href="#5.9">&sect;5.9</a>）。


<p>
对一个全局变量 <code>x</code> 的访问
等价于 <code>_env.x</code>，而这又可以等价于

<pre>
     gettable_event(_env, "x")
</pre>

<p>
这里，<code>_env</code> 是当前运行的函数的环境。
（函数 <code>gettable_event</code> 的完整说明参见 <a href="#2.8">&sect;2.8</a>。
这个函数并没有在 lua 中定义出来，也不能调用。
当然，<code>_env</code> 这个变量也同样没有在 Lua 中定义出来。
我们在这里使用它们，仅仅只是方便解释而已。）



<h2>2.4 - <a name="2.4">语句段（Statement）</a></h2>

<p>
Lua 支持惯例形式的语句段，它和 Pascal 或是 C 很相象。
这个集合包括赋值，控制结构，函数调用，还有变量声明。

<h3>2.4.1 - <a name="2.4.1">Chunk（语句组）</a></h3>

<p>
Lua 的一个执行单元被称作 <em>chunk</em>。
一个 chunk 就是一串语句段，它们会被循序的执行。
每个语句段可以以一个分号结束：

<pre>
	chunk ::= {stat [`<b>;</b>&acute;]}

</pre><p>
这儿不允许有空的语句段，所以 '<code>;;</code>' 是非法的。

<p>
lua 把一个 chunk 当作一个拥有不定参数的匿名函数
（参见 <a href="#2.5.9">&sect;2.5.9</a>）处理。
正是这样，chunk 内可以定义局部变量，接收参数，并且返回值。

<p>
chunk 可以被保存在一个文件中，也可以保存在宿主程序的一个字符串中。
当一个 chunk 被执行，首先它会被预编译成虚拟机中的指令序列，
然后被虚拟机解释运行这些指令。


<p>
chunk 也可以被预编译成二进制形式；细节参考程序 <code>luac</code>。
用源码形式提供的程序和被编译过的二进制形式的程序是可以相互替换的；
Lua 会自动识别文件类型并做正确的处理。


<h3>2.4.2 - <a name="2.4.2">语句块</a></h3><p>

语句块是一列语句段；从语法上来说，一个语句块跟一个 chunk 相同：

<pre>
	block ::= chunk
</pre>

<p>
一个语句块可以被显式的写成一个单独的语句段：

<pre>
	stat ::= <b>do</b> block <b>end</b>
</pre><p>

显式的语句块对于控制变量的作用范围很有用。
有时候，显式的语句块被用来在另一个语句块中插入
<b>return</b> 或是 <b>break</b> （参见 <a href="#2.4.4">&sect;2.4.4</a>）。


<h3>2.4.3 - <a name="2.4.3">赋值</a></h3>

<p>
Lua 允许多重赋值。
因此，赋值的语法定义是等号左边放一系列变量，
而等号右边放一系列的表达式。
两边的元素都用逗号间开：

<pre>
	stat ::= varlist1 `<b>=</b>&acute; explist1
	varlist1 ::= var {`<b>,</b>&acute; var}
	explist1 ::= exp {`<b>,</b>&acute; exp}

</pre><p>
表达式放在 <a href="#2.5">&sect;2.5</a> 里讨论。


<p>
在作赋值操作之前，
那一系列的右值会被对齐到左边变量需要的个数。
如果右值比需要的更多的话，多余的值就被扔掉。
如果右值的数量不够需求，
将会按所需扩展若干个 <b>nil</b>。
如果表达式列表以一个函数调用结束，
这个函数所返回的所有值都会在对齐操作之前被置入右值序列中。
（除非这个函数调用被用括号括了起来；参见 <a href="#2.5">&sect;2.5</a>）。

<p>
赋值段首先会做运算完所有的表达式，然后仅仅做赋值操作。
因此，下面这段代码

<pre>
     i = 3
     i, a[i] = i+1, 20
</pre><p>

会把 <code>a[3]</code> 设置为 20，而不会影响到 <code>a[4]</code> 。
这是因为 <code>a[i]</code> 中的 <code>i</code> 在被赋值为 4 之前就被拿出来了（那时是 3 ）。
简单说 ，这样一行

<pre>
     x, y = y, x
</pre>

<p>
可以用来交换 <code>x</code> 和 <code>y</code> 中的值。


<p>
对全局变量以及 table 中的域的赋值操作的含义可以通过 metatable 来改变。
对变量下标指向的赋值，即 <code>t[i] = val</code> 等价于
<code>settable_event(t,i,val)</code>。
（关于函数 <code>settable_event</code> 的详细说明，参见 <a href="#2.8">&sect;2.8</a>。
这个函数并没有在 Lua 中定义出来，也不可以被调用。
这里我们列出来，仅仅出于方便解释的目的）



<p>
对于全局变量的赋值 <code>x = val</code>
等价于
<code>_env.x = val</code>，这个又可以等价于

<pre>
     settable_event(_env, "x", val)
</pre><p>
这里，<code>_env</code> 指的是正在运行中的函数的环境。
（变量 <code>_env</code> 并没有在 Lua 中定义出来。
我们仅仅出于解释的目的在这里写出来。）


<h3>2.4.4 - <a name="2.4.4">控制结构</a></h3><p>
<b>if</b>、 <b>while</b>、以及 <b>repeat</b> 这些控制结构符合通常的意义，而且也有类似的语法：

<pre>
	stat ::= <b>while</b> exp <b>do</b> block <b>end</b>

	stat ::= <b>repeat</b> block <b>until</b> exp
	stat ::= <b>if</b> exp <b>then</b> block {<b>elseif</b> exp <b>then</b> block} [<b>else</b> block] <b>end</b>

</pre><p>

Lua 也有一个 <b>for</b> 语句，它有两种形式（参见 <a href="#2.4.5">&sect;2.4.5</a>）。


<p>
控制结构中的条件表达式可以返回任何值。
<b>false</b> 和 <b>nil</b> 两者都被认为是假条件。
所有不同于 <b>nil</b> 和 <b>false</b> 的其它值都被认为是真
（特别需要注意的是，数字 0 和空字符串也被认为是真）。



<p>
在 <b>repeat</b>&ndash;<b>until</b> 循环中，
内部语句块的结束点不是在 <b>until</b> 这个关键字处，
它还包括了其后的条件表达式。
因此，条件表达式中可以使用循环内部语句块中的定义的局部变量。

<p>
<b>return</b> 被用于从函数或是 chunk（其实它就是一个函数）中
返回值。

函数和 chunk 可以返回不只一个值，
所以 <b>return</b> 的语法为

<pre>

	stat ::= <b>return</b> [explist1]
</pre>

<p>
<b>break</b> 被用来结束
<b>while</b>、 <b>repeat</b>、或 <b>for</b> 循环，
它将忽略掉循环中下面的语句段的运行：


<pre>
	stat ::= <b>break</b>
</pre><p>

<b>break</b> 跳出最内层的循环。


<p>
<b>return</b> 和 <b>break</b> 只能被写在一个语句块的最后一句。
如果你真的需要从语句块的中间 <b>return</b> 或是 <b>break</b> ，
你可以使用显式的声名一个内部语句块。
一般写作 <code>do return end</code> 或是 <code>do break end</code>，
可以这样写是因为现在 <b>return</b> 或 <b>break</b> 都成了一个语句块的最后一句了。



<h3>2.4.5 - <a name="2.4.5">For 语句</a></h3>

<p>

<b>for</b> 有两种形式：一种是数字形式，另一种是一般形式。

<p>
数字形式的 <b>for</b> 循环，通过一个数学运算不断的运行内部的代码块。
下面是它的语法：

<pre>
	stat ::= <b>for</b> Name `<b>=</b>&acute; exp `<b>,</b>&acute; exp [`<b>,</b>&acute; exp] <b>do</b> block <b>end</b>

</pre><p>
<em>block</em> 将把 <em>name</em> 作循环变量。从第一个 <em>exp</em> 开始起，直到第二个 <em>exp</em> 的值为止，其步长为
第三个 <em>exp</em> 。
更确切的说，一个 <b>for</b> 循环看起来是这个样子


<pre>
     for v = <em>e1</em>, <em>e2</em>, <em>e3</em> do <em>block</em> end
</pre><p>
这等价于代码：

<pre>
     do
       local <em>var</em>, <em>limit</em>, <em>step</em> = tonumber(<em>e1</em>), tonumber(<em>e2</em>), tonumber(<em>e3</em>)
       if not (<em>var</em> and <em>limit</em> and <em>step</em>) then error() end
       while (<em>step</em> &gt; 0 and <em>var</em> &lt;= <em>limit</em>) or (<em>step</em> &lt;= 0 and <em>var</em> &gt;= <em>limit</em>) do
         local v = <em>var</em>

         <em>block</em>
         <em>var</em> = <em>var</em> + <em>step</em>
       end
     end
</pre><p>

注意下面这几点：


<ul>

<li>
所有三个控制表达式都只被运算一次，表达式的计算在循环开始之前。
这些表达式的结果必须是数字。
</li>

<li>
<code><em>var</em></code> 、<code><em>limit</em></code> 、以及 <code><em>step</em></code> 都是一些不可见的变量。
这里给它们起的名字都仅仅用于解释方便。
</li>

<li>
如果第三个表达式（步长）没有给出，会把步长设为 1 。
</li>

<li>
你可以用 <b>break</b> 来退出 <b>for</b> 循环。
</li>

<li>
循环变量 <code>v</code> 是一个循环内部的局部变量；
当 <b>for</b> 循环结束后，你就不能在使用它。
如果你需要这个值，在退出循环前把它赋给另一个变量。

</li>

</ul>

<p>
一般形式的 <b>for</b> 通过一个叫作迭代器（<em>iterators</em>）的函数工作。
每次迭代，迭代器函数都会被调用以产生一个新的值，
当这个值为 <b>nil</b> 时，循环停止。
一般形式的 <b>for</b> 循环的语法如下：


<pre>
	stat ::= <b>for</b> namelist <b>in</b> explist1 <b>do</b> block <b>end</b>
	namelist ::= Name {`<b>,</b>&acute; Name}

</pre><p>
<b>for</b> 语句好似这样

<pre>
     for <em>var_1</em>, &middot;&middot;&middot;, <em>var_n</em> in <em>explist</em> do <em>block</em> end

</pre><p>
它等价于这样一段代码：

<pre>
     do
       local <em>f</em>, <em>s</em>, <em>var</em> = <em>explist</em>
       while true do
         local <em>var_1</em>, &middot;&middot;&middot;, <em>var_n</em> = <em>f</em>(<em>s</em>, <em>var</em>)
         <em>var</em> = <em>var_1</em>

         if <em>var</em> == nil then break end
         <em>block</em>
       end
     end
</pre><p>
注意以下几点：

<ul>

<li>
<code><em>explist</em></code> 只会被计算一次。
它返回三个值， 一个迭代器函数，一个状态，一个迭代器的初始值。

</li>

<li>
<code><em>f</em></code>、 <code><em>s</em></code>、 以及 <code><em>var</em></code> 都是不可见的变量。
这里给它们起的名字都只是为了解说方便。
</li>

<li>
你可以使用 <b>break</b> 来跳出 <b>for</b> 循环。

</li>

<li>
循环变量 <code><em>var_i</em></code> 对于循环来说是一个局部变量；
你不可以在 <b>for</b> 循环结束后继续使用。
如果你需要保留这些值，那么就在循环结束前赋值到别的变量里去。
</li>

</ul>




<h3>2.4.6 - <a name="2.4.6">把函数调用作为语句段</a></h3><p>
为了允许使用可能的副作用，
函数调用可以被作为一个语句段执行：

<pre>
	stat ::= functioncall
</pre><p>
在这种情况下，所有的返回值都被舍弃。
函数调用在 <a href="#2.5.8">&sect;2.5.8</a> 中解释。


<h3>2.4.7 - <a name="2.4.7">局部变量声名</a></h3><p>
局部变量可以在语句块中任何地方声名。
声名可以包含一个初始化赋值操作：

<pre>

	stat ::= <b>local</b> namelist [`<b>=</b>&acute; explist1]
</pre><p>
如果有的话，初始化赋值操作的行为等同于赋值操作（参见 <a href="#2.4.3">&sect;2.4.3</a>）。
否则，所有的变量将被初始化为 <b>nil</b>。


<p>
一个 chunk 同时也是一个语句块（参见 <a href="#2.4.1">&sect;2.4.1</a>），
所以局部变量可以放在 chunk 中那些显式注明的语句块之外。
这些局部变量的作用范围从声明起一直延伸到 chunk 末尾。


<p>
局部变量的可见规则在 <a href="#2.6">&sect;2.6</a> 中解释。


<h2>2.5 - <a name="2.5">表达式</a></h2>

<p>
Lua 中有这些基本表达式：

<pre>
	exp ::= prefixexp
	exp ::= <b>nil</b> | <b>false</b> | <b>true</b>

	exp ::= Number
	exp ::= String
	exp ::= function
	exp ::= tableconstructor
	exp ::= `<b>...</b>&acute;
	exp ::= exp binop exp
	exp ::= unop exp
	prefixexp ::= var | functioncall | `<b>(</b>&acute; exp `<b>)</b>&acute;
</pre>

<p>
数字和字符串在 <a href="#2.1">&sect;2.1</a> 中解释；
变量在 <a href="#2.3">&sect;2.3</a> 中解释；
函数定义在 <a href="#2.5.9">&sect;2.5.9</a> 中解释；
函数调用在 <a href="#2.5.8">&sect;2.5.8</a> 中解释；
table 的构造在 <a href="#2.5.7">&sect;2.5.7</a> 中解释；
可变参数的表达式写作三个点 ('<code>...</code>') ，它只能被用在有可变参数的函数中；
这些在 <a href="#2.5.9">&sect;2.5.9</a> 中解释。



<p>
二元操作符包含有数学运算操作符（参见 <a href="#2.5.1">&sect;2.5.1</a>），
比较操作符（参见 <a href="#2.5.2">&sect;2.5.2</a>），逻辑操作符（参见 <a href="#2.5.3">&sect;2.5.3</a>），
以及连接操作符（参见 <a href="#2.5.4">&sect;2.5.4</a>）。
一元操作符包括负号（参见see <a href="#2.5.1">&sect;2.5.1</a>），
取反 <b>not</b>（参见 <a href="#2.5.3">&sect;2.5.3</a>），
和取长度操作符（参见 <a href="#2.5.5">&sect;2.5.5</a>）。



<p>
函数调用和可变参数表达式都可以放在多重返回值中。
如果表达式作为一个独立语句段出现（参见 <a href="#2.4.6">&sect;2.4.6</a>）
（这只能是一个函数调用），
它们的返回列表将被对齐到零个元素，也就是忽略所有返回值。
如果表达式用于表达式列表的最后（或者是唯一）的元素，
就不会有任何的对齐操作（除非函数调用用括号括起来）。
在任何其它的情况下，Lua 将把表达式结果看成单一元素，
忽略除第一个之外的任何值。

<p>
这里有一些例子：

<pre>
     f()                -- 调整到 0 个结果
     g(f(), x)          -- f() 被调整到一个结果
     g(x, f())          -- g 被传入 x 加上所有 f() 的返回值
     a,b,c = f(), x     -- f() 被调整到一个结果 （ c 在这里被赋为 nil ）
     a,b = ...          -- a 被赋值为可变参数中的第一个，
                        -- b 被赋值为第二个 （如果可变参数中并没有对应的值，
						-- 这里 a 和 b 都有可能被赋为 nil）
     
     a,b,c = x, f()     -- f() 被调整为两个结果
     a,b,c = f()        -- f() 被调整为三个结果
     return f()         -- 返回 f() 返回的所有结果
     return ...         -- 返回所有从可变参数中接收来的值
     return x,y,f()     -- 返回 x, y, 以及所有 f() 的返回值
     {f()}              -- 用 f() 的所有返回值创建一个列表
     {...}              -- 用可变参数中的所有值创建一个列表
     {f(), nil}         -- f() 被调整为一个结果
</pre>

<p>
被括号括起来的表达式永远被当作一个值。所以，
<code>(f(x,y,z))</code> 即使 <code>f</code> 返回多个值，这个表达式永远是一个单一值。
（<code>(f(x,y,z))</code> 的值是 <code>f</code> 返回的第一个值。如果 <code>f</code>

不返回值的话，那么它的值就是 <b>nil</b> 。）


<h3>2.5.1 - <a name="2.5.1">数学运算操作符</a></h3><p>
Lua 支持常见的数学运算操作符：
二元操作 <code>+</code> （加法），
<code>-</code> （减法），<code>*</code> （乘法），

<code>/</code> （除法）， <code>%</code> （取模），以及 <code>^</code> （幂）；
和一元操作 <code>-</code> （取负）。
如果对数字操作，或是可以转换为数字的字符串（参见 <a href="#2.2.1">&sect;2.2.1</a>），
所有这些操作都依赖它通常的含义。
幂操作可以对任何幂值都正常工作。比如，
<code>x^(-0.5)</code> 将计算出 <code>x</code> 平方根的倒数。
取模操作被定义为


<pre>
     a % b == a - math.floor(a/b)*b
</pre><p>
这就是说，其结果是商相对负无穷圆整后的余数。（译注：负数对正数取模的结果为正数）


<h3>2.5.2 - <a name="2.5.2">比较操作符</a></h3><p>
Lua 中的比较操作符有

<pre>
     ==    ~=    &lt;     &gt;     &lt;=    &gt;=
</pre><p>

这些操作的结果不是 <b>false</b> 就是 <b>true</b>。


<p>
等于操作 (<code>==</code>) 首先比较操作数的类型。
如果类型不同，结果就是 <b>false</b>。
否则，继续比较值。
数字和字符串都用常规的方式比较。
对象 （table ，userdata ，thread ，以及函数）以引用的形式比较：
两个对象只有在它们指向同一个东西时才认为相等。
每次你创建一个新对象（一个 table 或是 userdata ，thread 函数），
它们都各不相同，即不同于上次创建的东西。


<p>
你可以改变 Lua 比较 table 和 userdata 的方式，这需要使用 "eq" 这个原方法
（参见 <a href="#2.8">&sect;2.8</a>）。


<p>

<a href="#2.2.1">&sect;2.2.1</a> 中提及的转换规则并不作用于比较操作。
所以， <code>"0"==0</code> 等于 <b>false</b>，
而且 <code>t[0]</code> 和 <code>t["0"]</code> 描述的是 table 中不同的域。

<p>
操作符 <code>~=</code> 完全等价于 (<code>==</code>) 操作的反值。



<p>
大小比较操作以以下方式进行。
如果参数都是数字，那么就直接做数字比较。
否则，如果参数都是字符串，就用字符串比较的方式进行。
再则，Lua 就试着调用 "lt" 或是 "le" 元方法
（参见 <a href="#2.8">&sect;2.8</a>）。

<h3>2.5.3 - <a name="2.5.3">逻辑操作符</a></h3><p>
Lua 中的逻辑操作符有
<b>and</b>, <b>or</b>, 以及 <b>not</b>。
和控制结构（参见 <a href="#2.4.4">&sect;2.4.4</a>）一样，
所有的逻辑操作符把 <b>false</b> 和 <b>nil</b> 都作为假，
而其它的一切都当作真。



<p>
取反操作 <b>not</b> 总是返回 <b>false</b> 或 <b>true</b> 中的一个。
与操作符 <b>and</b> 在第一个参数为 <b>false</b> 或 <b>nil</b> 时
返回这第一个参数；
否则，<b>and</b> 返回第二个参数。
或操作符 <b>or</b> 在第一个参数不为 <b>nil</b> 也不为 <b>false</b> 时，
返回这第一个参数，否则返回第二个参数。

<b>and</b> 和 <b>or</b> 都遵循短路规则；
也就是说，第二个操作数只在需要的时候去求值。
这里有一些例子：

<pre>
     10 or 20            --&gt; 10
     10 or error()       --&gt; 10
     nil or "a"          --&gt; "a"
     nil and 10          --&gt; nil
     false and error()   --&gt; false
     false and nil       --&gt; false
     false or nil        --&gt; nil
     10 and 20           --&gt; 20

</pre><p>
（在这本手册中，
--&gt; 指前面表达式的结果。）



<h3>2.5.4 - <a name="2.5.4">连接符</a></h3><p>
Lua 中字符串的连接操作符写作两个点 ('<code>..</code>')。
如果两个操作数都是字符串或都是数字，连接操作将以 <a href="#2.2.1">&sect;2.2.1</a> 中提到的规则把其转换为字符串。
否则，会取调用元方法 "concat" （参见 <a href="#2.8">&sect;2.8</a>）。


<h3>2.5.5 - <a name="2.5.5">取长度操作符</a></h3>

<p>
取长度操作符写作一元操作 <code>#</code>。
字符串的长度是它的字节数（就是以一个字符一个字节计算的字符串长度）。


<p>
table <code>t</code> 的长度被定义成一个整数下标 <code>n</code> 。
它满足 <code>t[n]</code> 不是 <b>nil</b> 而 <code>t[n+1]</code> 为 <b>nil</b>；
此外，如果 <code>t[1]</code> 为 <b>nil</b> ，<code>n</code> 就可能是零。
对于常规的数组，里面从 1 到 <code>n</code> 放着一些非空的值的时候，
它的长度就精确的为 <code>n</code>，即最后一个值的下标。
如果数组有一个“空洞” （就是说，<b>nil</b> 值被夹在非空值之间），
那么 <code>#t</code> 可能是指向任何一个是 <b>nil</b> 值的前一个位置的下标
（就是说，任何一个 <b>nil</b> 值都有可能被当成数组的结束）。






<h3>2.5.6 - <a name="2.5.6">优先级</a></h3><p>
Lua 中操作符的优先级写在下表中，从低到高优先级排序：

<pre>
     or
     and
     &lt;     &gt;     &lt;=    &gt;=    ~=    ==
     ..
     +     -
     *     /     %
     not   #     - (unary)
     ^
</pre><p>
通常，你可以用括号来改变运算次序。
连接操作符 ('<code>..</code>') 和幂操作 ('<code>^</code>') 是从右至左的。
其它所有的操作都是从左至右。



<h3>2.5.7 - <a name="2.5.7">Table 构造</a></h3><p>
table 构造子是一个构造 table 的表达式。
每次构造子被执行，都会构造出一个新的 table 。
构造子可以被用来构造一个空的 table，
也可以用来构造一个 table 并初始化其中的一些域。
一般的构造子的语法如下

<pre>
	tableconstructor ::= `<b>{</b>&acute; [fieldlist] `<b>}</b>&acute;
	fieldlist ::= field {fieldsep field} [fieldsep]
	field ::= `<b>[</b>&acute; exp `<b>]</b>&acute; `<b>=</b>&acute; exp | Name `<b>=</b>&acute; exp | exp
	fieldsep ::= `<b>,</b>&acute; | `<b>;</b>&acute;

</pre>

<p>
每个形如 <code>[exp1] = exp2</code> 的域向 table 中增加新的一项，
其键值为 <code>exp1</code> 而值为 <code>exp2</code>。
形如 <code>name = exp</code> 的域等价于
<code>["name"] = exp</code>。
最后，形如 <code>exp</code> 的域等价于

<code>[i] = exp</code> ， 这里的 <code>i</code> 是一个从 1 开始不断增长的数字。
这这个格式中的其它域不会破坏其记数。
举个例子：

<pre>
     a = { [f(1)] = g; "x", "y"; x = 1, f(x), [30] = 23; 45 }
</pre><p>
等价于

<pre>
     do
       local t = {}
       t[f(1)] = g
       t[1] = "x"         -- 1st exp
       t[2] = "y"         -- 2nd exp
       t.x = 1            -- t["x"] = 1
       t[3] = f(x)        -- 3rd exp
       t[30] = 23
       t[4] = 45          -- 4th exp
       a = t
     end
</pre>

<p>

如果表单中最后一个域的形式是 <code>exp</code> ，
而且其表达式是一个函数调用或者是一个可变参数，
那么这个表达式所有的返回值将连续的进入列表
（参见 <a href="#2.5.8">&sect;2.5.8</a>）。
为了避免这一点，你可以用括号把函数调用（或是可变参数）括起来
（参见 <a href="#2.5">&sect;2.5</a>）。


<p>
初始化域表可以在最后多一个分割符，
这样设计可以方便由机器生成代码。



<h3>2.5.8 - <a name="2.5.8">函数调用</a></h3><p>
Lua 中的函数调用的语法如下：

<pre>
	functioncall ::= prefixexp args

</pre><p>
函数调用时，第一步，prefixexp 和 args 先被求值。
如果 prefixexp 的值的类型是 <em>function</em>，
那么这个函数就被用给出的参数调用。
否则 prefixexp 的元方法 "call" 就被调用，
第一个参数就是 prefixexp 的值，跟下来的是原来的调用参数
（参见 <a href="#2.8">&sect;2.8</a>）。


<p>
这样的形式

<pre>
	functioncall ::= prefixexp `<b>:</b>&acute; Name args
</pre><p>
可以用来调用 "方法"。
这是 Lua 支持的一种语法糖。像 <code>v:name(<em>args</em>)</code>

这个样子，被解释成 <code>v.name(v,<em>args</em>)</code>，
这里 <code>v</code> 只会被求值一次。


<p>
参数的语法如下：

<pre>
	args ::= `<b>(</b>&acute; [explist1] `<b>)</b>&acute;

	args ::= tableconstructor
	args ::= String
</pre><p>
所有参数的表达式求值都在函数调用之前。
这样的调用形式 <code>f{<em>fields</em>}</code> 是一种语法糖用于表示
 <code>f({<em>fields</em>})</code>；
这里指参数列表是一个单一的新创建出来的列表。
而这样的形式 <code>f'<em>string</em>'</code> 

（或是 <code>f"<em>string</em>"</code> 亦或是 <code>f[[<em>string</em>]]</code>）
也是一种语法糖，用于表示 <code>f('<em>string</em>')</code>；
这里指参数列表是一个单独的字符串。


<p>
因为表达式语法在 Lua 中比较自由，
所以你不能在函数调用的 '<code>(</code>' 前换行。
这个限制可以避免语言中的一些歧义。
比如你这样写


<pre>
     a = f
     (g).x(a)
</pre><p>
Lua 将把它当作一个单一语句段， <code>a = f(g).x(a)</code> 。
因此，如果你真的想作为成两个语句段，你必须在它们之间写上一个分号。
如果你真的想调用 <code>f</code>，
你必须从 <code>(g)</code> 前移去换行。


<p>
这样一种调用形式：<code>return</code> <em>functioncall</em> 将触发一个尾调用。
Lua 实现了适当的尾部调用（或是适当的尾递归）：
在尾调用中，
被调用的函数重用调用它的函数的堆栈项。
因此，对于程序执行的嵌套尾调用的层数是没有限制的。
然而，尾调用将删除调用它的函数的任何调试信息。
注意，尾调用只发生在特定的语法下，
这时， <b>return</b> 只有单一函数调用作为参数；
这种语法使得调用函数的结果可以精确返回。
因此，下面这些例子都不是尾调用：


<pre>
     return (f(x))        -- 返回值被调整为一个
     return 2 * f(x)
     return x, f(x)       -- 最加若干返回值
     f(x); return         -- 无返回值
     return x or f(x)     -- 返回值被调整为一个
</pre>




<h3>2.5.9 - <a name="2.5.9">函数定义</a></h3>

<p>
函数定义的语法如下：

<pre>
	function ::= <b>function</b> funcbody
	funcbody ::= `<b>(</b>&acute; [parlist1] `<b>)</b>&acute; block <b>end</b>

</pre>

<p>
另外定义了一些语法糖简化函数定义的写法：

<pre>
	stat ::= <b>function</b> funcname funcbody
	stat ::= <b>local</b> <b>function</b> Name funcbody
	funcname ::= Name {`<b>.</b>&acute; Name} [`<b>:</b>&acute; Name]

</pre><p>
这样的写法：
<pre>
     function f () <em>body</em> end
</pre><p>
被转换成
<pre>
     f = function () <em>body</em> end
</pre><p>

这样的写法：
<pre>
     function t.a.b.c.f () <em>body</em> end
</pre><p>
被转换成
<pre>
     t.a.b.c.f = function () <em>body</em> end
</pre><p>
这样的写法：

<pre>
     local function f () <em>body</em> end
</pre><p>
被转换成
<pre>
     local f; f = function () <em>body</em> end
</pre><p>
注意，并不是转换成
<pre>

     local f = function () <em>body</em> end
</pre><p>
（这个差别只在函数体内需要引用 <code>f</code> 时才有。）


<p>
一个函数定义是一个可执行的表达式，
执行结果是一个类型为 <em>function</em> 的值。
当 Lua 预编译一个 chunk 的时候，
chunk 作为一个函数，整个函数体也就被预编译了。
那么，无论何时 Lua 执行了函数定义，
这个函数本身就被实例化了（或者说是关闭了）。
这个函数的实例（或者说是 <em>closure</em>（闭包））
是表达式的最终值。
相同函数的不同实例有可能引用不同的外部局部变量，
也可能拥有不同的环境表。


<p>
形参（函数定义需要的参数）是一些由实参（实际传入参数）的值初始化的局部变量：

<pre>
	parlist1 ::= namelist [`<b>,</b>&acute; `<b>...</b>&acute;] | `<b>...</b>&acute;
</pre><p>
当一个函数被调用，
如果函数没有被定义为接收不定长参数，即在形参列表的末尾注明三个点 ('<code>...</code>')，
那么实参列表就会被调整到形参列表的长度，
变长参数函数不会调整实参列表；
取而代之的是，它将把所有额外的参数放在一起通过变长参数表达式传递给函数，
其写法依旧是三个点。
这个表达式的值是一串实参值的列表，看起来就跟一个可以返回多个结果的函数一样。
如果一个变长参数表达式放在另一个表达式中使用，或是放在另一串表达式的中间，
那么它的返回值就会被调整为单个值。
若这个表达式放在了一系列表达式的最后一个，就不会做调整了（除非用括号给括了起来）。


<p>

我们先做如下定义，然后再来看一个例子：

<pre>
     function f(a, b) end
     function g(a, b, ...) end
     function r() return 1,2,3 end
</pre><p>
下面看看实参到形参数以及可变长参数的映射关系：

<pre>
     CALL            PARAMETERS
     
     f(3)             a=3, b=nil
     f(3, 4)          a=3, b=4
     f(3, 4, 5)       a=3, b=4
     f(r(), 10)       a=1, b=10
     f(r())           a=1, b=2
     
     g(3)             a=3, b=nil, ... --&gt;  (nothing)
     g(3, 4)          a=3, b=4,   ... --&gt;  (nothing)
     g(3, 4, 5, 8)    a=3, b=4,   ... --&gt;  5  8
     g(5, r())        a=5, b=1,   ... --&gt;  2  3

</pre>

<p>
结果由 <b>return</b> 来返回（参见 <a href="#2.4.4">&sect;2.4.4</a>）。
如果执行到函数末尾依旧没有遇到任何 <b>return</b> 语句，
函数就不会返回任何结果。


<p>
冒号语法可以用来定义方法，
就是说，函数可以有一个隐式的形参 <code>self</code>。
因此，如下写法：

<pre>

     function t.a.b.c:f (<em>params</em>) <em>body</em> end
</pre><p>
是这样一种写法的语法糖：

<pre>
     t.a.b.c.f = function (self, <em>params</em>) <em>body</em> end

</pre>






<h2>2.6 - <a name="2.6">可视规则</a></h2>

<p>
Lua 是一个有词法作用范围的语言。
变量的作用范围开始于声明它们之后的第一个语句段，
结束于包含这个声明的最内层语句块的结束点。
看下面这些例子：

<pre>
     x = 10                -- 全局变量
     do                    -- 新的语句块
       local x = x         -- 新的一个 'x', 它的值现在是 10
       print(x)            --&gt; 10
       x = x+1
       do                  -- 另一个语句块
         local x = x+1     -- 又一个 'x'
         print(x)          --&gt; 12
       end
       print(x)            --&gt; 11
     end
     print(x)              --&gt; 10  （取到的是全局的那一个）

</pre>

<p>
注意这里，类似 <code>local x = x</code> 这样的声明，
新的 <code>x</code> 正在被声明，但是还没有进入它的作用范围，
所以第二个 <code>x</code> 指向的是外面一层的变量。


<p>
因为有这样一个词法作用范围的规则，
所以可以在函数内部自由的定义局部变量并使用它们。
当一个局部变量被更内层的函数中使用的时候，
它被内层函数称作
<em>upvalue</em>（上值），或是 <em>外部局部变量</em>。


<p>
注意，每次执行到一个 local 语句都会定义出一个新的局部变量。
看看这样一个例子：

<pre>
     a = {}
     local x = 20
     for i=1,10 do
       local y = 0
       a[i] = function () y=y+1; return x+y end
     end
</pre><p>
这个循环创建了十个 closure（这指十个匿名函数的实例）。
这些 closure 中的每一个都使用了不同的 <code>y</code> 变量，
而它们又共享了同一份 <code>x</code>。


<h2>2.7 - <a name="2.7">错误处理</a></h2>

<p>

因为 Lua 是一个嵌入式的扩展语言，
所有的 Lua 动作都是从宿主程序的 C 代码调用 Lua 库
（参见 <a href="#lua_pcall"><code>lua_pcall</code></a>）中的一个函数开始的。
在 Lua 编译或运行的任何时候发生了错误，控制权都会交还给 C ，
而 C 可以来做一些恰当的措施（比如打印出一条错误信息）。

<p>
Lua 代码可以显式的调用 <a href="#pdf-error"><code>error</code></a> 函数来产生一条错误。
如果你需要在 Lua 中捕获发生的错误，
你可以使用 <a href="#pdf-pcall"><code>pcall</code></a> 函数。

<h2>2.8 - <a name="2.8">Metatable（元表）</a></h2>

<p>
Lua 中的每个值都可以用一个 <em>metatable</em>。
这个 <em>metatable</em> 就是一个原始的 Lua table ，
它用来定义原始值在特定操作下的行为。
你可以通过在 metatable 中的特定域设一些值来改变拥有这个 metatable 的值
的指定操作之行为。
举例来说，当一个非数字的值作加法操作的时候，
Lua 会检查它的 metatable 中 <code>"__add"</code> 域中的是否有一个函数。
如果有这么一个函数的话，Lua 调用这个函数来执行一次加法。



<p>
我们叫 metatable 中的键名为 <em>事件 (event)</em> ，把其中的值叫作 <em>元方法 (metamethod)</em>。
在上个例子中，事件是 <code>"add"</code> 而元方法就是那个执行加法操作的函数。


<p>
你可以通过 <a href="#pdf-getmetatable"><code>getmetatable</code></a> 函数来查询到任何一个值的 metatable。


<p>
你可以通过 <a href="#pdf-setmetatable"><code>setmetatable</code></a> 函数来替换掉 table 的 metatable 。
你不能从 Lua 中改变其它任何类型的值的 metatable （使用 debug 库例外）；
要这样做的话必须使用 C API 。



<p>
每个 table 和 userdata 拥有独立的 metatable （当然多个 table 和 userdata
可以共享一个相同的表作它们的 metatable）；
其它所有类型的值，每种类型都分别共享唯一的一个 metatable。
因此，所有的数字一起只有一个 metatable ，所有的字符串也是，等等。


<p>
一个 metatable 可以控制一个对象做数学运算操作、比较操作、连接操作、取长度操作、取下标操作时的行为，
metatable 中还可以定义一个函数，让 userdata 作垃圾收集时调用它。
对于这些操作，Lua 都将其关联上一个被称作事件的指定健。
当 Lua 需要对一个值发起这些操作中的一个时，
它会去检查值中 metatable 中是否有对应事件。
如果有的话，键名对应的值（元方法）将控制 Lua 怎样做这个操作。


<p>
metatable 可以控制的操作已在下面列出来。
每个操作都用相应的名字区分。
每个操作的键名都是用操作名字加上两个下划线 '<code>__</code>' 前缀的字符串；
举例来说，"add" 操作的键名就是字符串 <code>"__add"</code>。
这些操作的语义用一个 Lua 函数来描述解释器如何执行更为恰当。

<p>
这里展示的用 Lua 写的代码仅作解说用；
实际的行为已经硬编码在解释器中，其执行效率要远高于这些模拟代码。
这些用于描述的的代码中用到的函数
（ <a href="#pdf-rawget"><code>rawget</code></a> ， <a href="#pdf-tonumber"><code>tonumber</code></a> ，等等。）
都可以在 <a href="#5.1">&sect;5.1</a> 中找到。
特别注意，我们使用这样一个表达式来从给定对象中提取元方法


<pre>
     metatable(obj)[event]
</pre><p>

这个应该被解读作

<pre>
     rawget(getmetatable(obj) or {}, event)
</pre><p>

这就是说，访问一个元方法不再会触发任何的元方法，
而且访问一个没有 metatable 的对象也不会失败（而只是简单返回 <b>nil</b>）。


<ul>

<li><b>"add":</b>

<code>+</code> 操作。



<p>
下面这个 <code>getbinhandler</code> 函数定义了 Lua 怎样选择一个处理器来作二元操作。
首先，Lua 尝试第一个操作数。
如果这个东西的类型没有定义这个操作的处理器，然后 Lua 会尝试第二个操作数。

<pre>
     function getbinhandler (op1, op2, event)
       return metatable(op1)[event] or metatable(op2)[event]
     end
</pre><p>
通过这个函数， <code>op1 + op2</code> 的行为就是

<pre>

     function add_event (op1, op2)
       local o1, o2 = tonumber(op1), tonumber(op2)
       if o1 and o2 then  -- 两个操作数都是数字？
         return o1 + o2   -- 这里的 '+' 是原生的 'add'
       else  -- 至少一个操作数不是数字时
         local h = getbinhandler(op1, op2, "__add")
         if h then
           -- 以两个操作数来调用处理器
           return h(op1, op2)
         else  -- 没有处理器：缺省行为
           error(&middot;&middot;&middot;)
         end
       end
     end
</pre><p>
</li>

<li><b>"sub":</b>
<code>-</code> 操作。

其行为类似于 "add" 操作。
</li>

<li><b>"mul":</b>
<code>*</code> 操作。

其行为类似于 "add" 操作。

</li>

<li><b>"div":</b>
<code>/</code> 操作。

其行为类似于 "add" 操作。
</li>

<li><b>"mod":</b>
<code>%</code> 操作。

其行为类似于 "add" 操作，
它的原生操作是这样的
<code>o1 - floor(o1/o2)*o2</code>
</li>

<li><b>"pow":</b>
<code>^</code> （幂）操作。

其行为类似于 "add" 操作，
它的原生操作是调用 <code>pow</code> 函数（通过 C math 库）。
</li>

<li><b>"unm":</b>
一元 <code>-</code> 操作。



<pre>
     function unm_event (op)
       local o = tonumber(op)
       if o then  -- 操作数是数字？
         return -o  -- 这里的 '-' 是一个原生的 'unm'
       else  -- 操作数不是数字。
         -- 尝试从操作数中得到处理器
         local h = metatable(op).__unm
         if h then
           -- 以操作数为参数调用处理器
           return h(op)
         else  -- 没有处理器：缺省行为
           error(&middot;&middot;&middot;)
         end
       end
     end
</pre><p>
</li>

<li><b>"concat":</b>
<code>..</code> （连接）操作，


<pre>
     function concat_event (op1, op2)
       if (type(op1) == "string" or type(op1) == "number") and
          (type(op2) == "string" or type(op2) == "number") then
         return op1 .. op2  -- 原生字符串连接
       else
         local h = getbinhandler(op1, op2, "__concat")
         if h then
           return h(op1, op2)
         else
           error(&middot;&middot;&middot;)
         end
       end
     end
</pre><p>

</li>

<li><b>"len":</b>
<code>#</code> 操作。


<pre>
     function len_event (op)
       if type(op) == "string" then
         return strlen(op)         -- 原生的取字符串长度
       elseif type(op) == "table" then
         return #op                -- 原生的取 table 长度
       else
         local h = metatable(op).__len
         if h then
           -- 调用操作数的处理器
           return h(op)
         else  -- 没有处理器：缺省行为
           error(&middot;&middot;&middot;)
         end
       end
     end
</pre><p>
关于 table 的长度参见 <a href="#2.5.5">&sect;2.5.5</a> 。
</li>

<li><b>"eq":</b>
<code>==</code> 操作。

函数 <code>getcomphandler</code> 定义了 Lua 怎样选择一个处理器来作比较操作。
元方法仅仅在参于比较的两个对象类型相同且有对应操作相同的元方法时才起效。

<pre>
     function getcomphandler (op1, op2, event)
       if type(op1) ~= type(op2) then return nil end
       local mm1 = metatable(op1)[event]
       local mm2 = metatable(op2)[event]
       if mm1 == mm2 then return mm1 else return nil end
     end
</pre><p>
"eq" 事件按如下方式定义：

<pre>
     function eq_event (op1, op2)
       if type(op1) ~= type(op2) then  -- 不同的类型？
         return false   -- 不同的对象
       end
       if op1 == op2 then   -- 原生的相等比较结果？
         return true   -- 对象相等
       end
       -- 尝试使用元方法
       local h = getcomphandler(op1, op2, "__eq")
       if h then
         return h(op1, op2)
       else
         return false
       end
     end

</pre><p>
<code>a ~= b</code> 等价于 <code>not (a == b)</code> 。
</li>

<li><b>"lt":</b>
<code>&lt;</code> 操作。


<pre>
     function lt_event (op1, op2)
       if type(op1) == "number" and type(op2) == "number" then
         return op1 &lt; op2   -- 数字比较
       elseif type(op1) == "string" and type(op2) == "string" then
         return op1 &lt; op2   -- 字符串按逐字符比较
       else
         local h = getcomphandler(op1, op2, "__lt")
         if h then
           return h(op1, op2)
         else
           error(&middot;&middot;&middot;);
         end
       end
     end

</pre><p>
<code>a &gt; b</code> 等价于 <code>b &lt; a</code>.
</li>

<li><b>"le":</b>
<code>&lt;=</code> 操作。



<pre>
     function le_event (op1, op2)
       if type(op1) == "number" and type(op2) == "number" then
         return op1 &lt;= op2   -- 数字比较
       elseif type(op1) == "string" and type(op2) == "string" then
         return op1 &lt;= op2   -- 字符串按逐字符比较
       else
         local h = getcomphandler(op1, op2, "__le")
         if h then
           return h(op1, op2)
         else
           h = getcomphandler(op1, op2, "__lt")
           if h then
             return not h(op2, op1)
           else
             error(&middot;&middot;&middot;);
           end
         end
       end
     end
</pre><p>
<code>a &gt;= b</code> 等价于 <code>b &lt;= a</code> 。
注意，如果元方法 "le" 没有提供，Lua 就尝试 "lt" ，
它假定 <code>a &lt;= b</code> 等价于 <code>not (b &lt; a)</code> 。

</li>

<li><b>"index":</b>
取下标操作用于访问 <code>table[key]</code> 。


<pre>
     function gettable_event (table, key)
       local h
       if type(table) == "table" then
         local v = rawget(table, key)
         if v ~= nil then return v end
         h = metatable(table).__index
         if h == nil then return nil end
       else
         h = metatable(table).__index
         if h == nil then
           error(&middot;&middot;&middot;);
         end
       end
       if type(h) == "function" then
         return h(table, key)      -- 调用处理器
       else return h[key]          -- 或是重复上述操作
       end
     end
</pre><p>
</li>

<li><b>"newindex":</b>

赋值给指定下标 <code>table[key] = value</code> 。


<pre>
     function settable_event (table, key, value)
       local h
       if type(table) == "table" then
         local v = rawget(table, key)
         if v ~= nil then rawset(table, key, value); return end
         h = metatable(table).__newindex
         if h == nil then rawset(table, key, value); return end
       else
         h = metatable(table).__newindex
         if h == nil then
           error(&middot;&middot;&middot;);
         end
       end
       if type(h) == "function" then
         return h(table, key,value)    -- 调用处理器
       else h[key] = value             -- 或是重复上述操作
       end
     end
</pre><p>
</li>

<li><b>"call":</b>
当 Lua 调用一个值时调用。


<pre>
     function function_event (func, ...)
       if type(func) == "function" then
         return func(...)   -- 原生的调用
       else
         local h = metatable(func).__call
         if h then
           return h(func, ...)
         else
           error(&middot;&middot;&middot;)
         end
       end
     end

</pre><p>
</li>

</ul>




<h2>2.9 - <a name="2.9">环境</a></h2>

<p>
类型为 thread ，function ，以及 userdata 
的对象，除了 metatable 外还可以用另外一个与之关联的被称作
它们的环境的一个表，
像 metatable 一样，环境也是一个常规的 table ，多个对象可以共享
同一个环境。

<p>
userdata 的环境在 Lua 中没有意义。
这个东西只是为了在程序员想把一个表关联到一个 userdata 上时提供便利。

<p>

关联在线程上的环境被称作全局环境。
全局环境被用作它其中的线程以及线程创建的非嵌套函数
（通过 <a href="#pdf-loadfile"><code>loadfile</code></a> ， <a href="#pdf-loadstring"><code>loadstring</code></a> 或是
<a href="#pdf-load"><code>load</code></a> ）的缺省环境。
而且它可以被 C 代码直接访问（参见 <a href="#3.3">&sect;3.3</a>）。


<p>
关联在 C 函数上的环境可以直接被 C 代码访问（参见 <a href="#3.3">&sect;3.3</a>）。
它们会作为这个 C 函数中创建的其它函数的缺省环境。


<p>

关联在 Lua 函数上的环境用来接管在函数内对全局变量（参见 <a href="#2.3">&sect;2.3</a>）的所有访问。
它们也会作为这个函数内创建的其它函数的缺省环境。

<p>
你可以通过调用 <a href="#pdf-setfenv"><code>setfenv</code></a> 来改变一个 Lua 函数
或是正在运行中的线程的环境。
而想操控其它对象（userdata、C 函数、其它线程）的环境的话，就必须使用 C API 。



<h2>2.10 - <a name="2.10">垃圾收集</a></h2>

<p>
Lua 提供了一个自动的内存管理。
这就是说你不需要关心创建新对象的分配内存操作，也不需要在这些对象不再需要时的主动释放内存。
Lua 通过运行一个垃圾收集器来自动管理内存，以此一遍又一遍的回收死掉的对象
（这是指 Lua 中不再访问的到的对象）占用的内存。
Lua 中所有对象都被自动管理，包括：
table, userdata、 函数、线程、和字符串。


<p>
Lua 实现了一个增量标记清除的收集器。
它用两个数字来控制垃圾收集周期：
<em>garbage-collector pause</em> 和 <em>garbage-collector step multiplier</em> 。



<p>
garbage-collector pause 控制了收集器在开始一个新的收集周期之前要等待多久。
随着数字的增大就导致收集器工作工作的不那么主动。
小于 1 的值意味着收集器在新的周期开始时不再等待。
当值为 2 的时候意味着在总使用内存数量达到原来的两倍时再开启新的周期。

<p>
step multiplier 控制了收集器相对内存分配的速度。
更大的数字将导致收集器工作的更主动的同时，也使每步收集的尺寸增加。
小于 1 的值会使收集器工作的非常慢，可能导致收集器永远都结束不了当前周期。
缺省值为 2 ，这意味着收集器将以内存分配器的两倍速运行。


<p>
你可以通过在 C 中调用 <a href="#lua_gc"><code>lua_gc</code></a> 或是在 Lua 中调用 
<a href="#pdf-collectgarbage"><code>collectgarbage</code></a> 来改变这些数字。
两者都接受百分比数值（因此传入参数 100 意味着实际值 1 ）。
通过这些函数，你也可以直接控制收集器（例如，停止或是重启）。


<h3>2.10.1 - <a name="2.10.1">垃圾收集的元方法</a></h3>

<p>

使用 C API　，
你可以给 userdata （参见 <a href="#2.8">&sect;2.8</a>）设置一个垃圾收集的元方法。
这个元方法也被称为结束子。
结束子允许你用额外的资源管理器和 Lua 的内存管理器协同工作
（比如关闭文件、网络连接、或是数据库连接，也可以说释放你自己的内存）。

<p>
一个 userdata 可被回收，若它的 metatable 中有 <code>__gc</code> 这个域　，
垃圾收集器就不立即收回它。
取而代之的是，Lua 把它们放到一个列表中。
最收集结束后，Lua 针对列表中的每个 userdata 执行了下面这个函数的等价操作：

<pre>
     function gc_event (udata)
       local h = metatable(udata).__gc
                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                 then <code>require</code> signals an error. 




<p>
<hr><h3><a name="pdf-package.cpath"><code>package.cpath</code></a></h3>


<p>
The path used by <a href="#pdf-require"><code>require</code></a> to search for a C&nbsp;loader.


<p>

Lua initializes the C&nbsp;path <a href="#pdf-package.cpath"><code>package.cpath</code></a> in the same way
it initializes the Lua path <a href="#pdf-package.path"><code>package.path</code></a>,
using the environment variable <a name="pdf-LUA_CPATH"><code>LUA_CPATH</code></a>
(plus another default path defined in <code>luaconf.h</code>).




<p>

<hr><h3><a name="pdf-package.loaded"><code>package.loaded</code></a></h3>

<p>
A table used by <a href="#pdf-require"><code>require</code></a> to control which
modules are already loaded.
When you require a module <code>modname</code> and
<code>package.loaded[modname]</code> is not false,
<a href="#pdf-require"><code>require</code></a> simply returns the value stored there.




<p>
<hr><h3><a name="pdf-package.loadlib"><code>package.loadlib (libname, funcname)</code></a></h3>


<p>
Dynamically links the host program with the C&nbsp;library <code>libname</code>.
Inside this library, looks for a function <code>funcname</code>
and returns this function as a C&nbsp;function.
(So, <code>funcname</code> must follow the protocol (see <a href="#lua_CFunction"><code>lua_CFunction</code></a>)).


<p>

This is a low-level function.
It completely bypasses the package and module system.
Unlike <a href="#pdf-require"><code>require</code></a>,
it does not perform any path searching and
does not automatically adds extensions.
<code>libname</code> must be the complete file name of the C&nbsp;library,
including if necessary a path and extension.
<code>funcname</code> must be the exact name exported by the C&nbsp;library
(which may depend on the C&nbsp;compiler and linker used).


<p>
This function is not supported by ANSI C.
As such, it is only available on some platforms
(Windows, Linux, Mac OS X, Solaris, BSD,
plus other Unix systems that support the <code>dlfcn</code> standard).





<p>
<hr><h3><a name="pdf-package.path"><code>package.path</code></a></h3>


<p>
The path used by <a href="#pdf-require"><code>require</code></a> to search for a Lua loader.


<p>
At start-up, Lua initializes this variable with
the value of the environment variable <a name="pdf-LUA_PATH"><code>LUA_PATH</code></a> or
with a default path defined in <code>luaconf.h</code>,
if the environment variable is not defined.
Any "<code>;;</code>" in the value of the environment variable
is replaced by the default path.



<p>
A path is a sequence of <em>templates</em> separated by semicolons.
For each template, <a href="#pdf-require"><code>require</code></a> will change each interrogation
mark in the template by <code>filename</code>,
which is <code>modname</code> with each dot replaced by a
"directory separator" (such as "<code>/</code>" in Unix);
then it will try to load the resulting file name.
So, for instance, if the Lua path is

<pre>
     "./?.lua;./?.lc;/usr/local/?/init.lua"

</pre><p>
the search for a Lua loader for module <code>foo</code>
will try to load the files
<code>./foo.lua</code>, <code>./foo.lc</code>, and
<code>/usr/local/foo/init.lua</code>, in that order.




<p>
<hr><h3><a name="pdf-package.preload"><code>package.preload</code></a></h3>


<p>

A table to store loaders for specific modules
(see <a href="#pdf-require"><code>require</code></a>).




<p>
<hr><h3><a name="pdf-package.seeall"><code>package.seeall (module)</code></a></h3>


<p>
Sets a metatable for <code>module</code> with
its <code>__index</code> field referring to the global environment,
so that this module inherits values
from the global environment.
To be used as an option to function <a href="#pdf-module"><code>module</code></a>.








<h2>5.4 - <a name="5.4">String Manipulation</a></h2>

<p>
This library provides generic functions for string manipulation,
such as finding and extracting substrings, and pattern matching.
When indexing a string in Lua, the first character is at position&nbsp;1
(not at&nbsp;0, as in C).
Indices are allowed to be negative and are interpreted as indexing backwards,
from the end of the string.
Thus, the last character is at position -1, and so on.


<p>
The string library provides all its functions inside the table
<a name="pdf-string"><code>string</code></a>.
It also sets a metatable for strings
where the <code>__index</code> field points to the <code>string</code> table.
Therefore, you can use the string functions in object-oriented style.
For instance, <code>string.byte(s, i)</code>

can be written as <code>s:byte(i)</code>.


<p>
<hr><h3><a name="pdf-string.byte"><code>string.byte (s [, i [, j]])</code></a></h3>
Returns the internal numerical codes of the characters <code>s[i]</code>,
<code>s[i+1]</code>, &middot;&middot;&middot;, <code>s[j]</code>.
The default value for <code>i</code> is&nbsp;1;
the default value for <code>j</code> is&nbsp;<code>i</code>.



<p>
Note that numerical codes are not necessarily portable across platforms.




<p>
<hr><h3><a name="pdf-string.char"><code>string.char (&middot;&middot;&middot;)</code></a></h3>
Receives zero or more integers.
Returns a string with length equal to the number of arguments,
in which each character has the internal numerical code equal
to its corresponding argument.


<p>
Note that numerical codes are not necessarily portable across platforms.




<p>
<hr><h3><a name="pdf-string.dump"><code>string.dump (function)</code></a></h3>


<p>
Returns a string containing a binary representation of the given function,
so that a later <a href="#pdf-loadstring"><code>loadstring</code></a> on this string returns
a copy of the function.

<code>function</code> must be a Lua function without upvalues.




<p>
<hr><h3><a name="pdf-string.find"><code>string.find (s, pattern [, init [, plain]])</code></a></h3>
Looks for the first match of
<code>pattern</code> in the string <code>s</code>.
If it finds a match, then <code>find</code> returns the indices of&nbsp;<code>s</code>

where this occurrence starts and ends;
otherwise, it returns <b>nil</b>.
A third, optional numerical argument <code>init</code> specifies
where to start the search;
its default value is&nbsp;1 and may be negative.
A value of <b>true</b> as a fourth, optional argument <code>plain</code>
turns off the pattern matching facilities,
so the function does a plain "find substring" operation,
with no characters in <code>pattern</code> being considered "magic".
Note that if <code>plain</code> is given, then <code>init</code> must be given as well.



<p>
If the pattern has captures,
then in a successful match
the captured values are also returned,
after the two indices.




<p>
<hr><h3><a name="pdf-string.format"><code>string.format (formatstring, &middot;&middot;&middot;)</code></a></h3>
Returns a formatted version of its variable number of arguments
following the description given in its first argument (which must be a string).
The format string follows the same rules as the <code>printf</code> family of
standard C&nbsp;functions.
The only differences are that the options/modifiers
<code>*</code>, <code>l</code>, <code>L</code>, <code>n</code>, <code>p</code>,
and <code>h</code> are not supported
and that there is an extra option, <code>q</code>.
The <code>q</code> option formats a string in a form suitable to be safely read
back by the Lua interpreter:
the string is written between double quotes,
and all double quotes, newlines, embedded zeros,
and backslashes in the string
are correctly escaped when written.
For instance, the call


<pre>
     string.format('%q', 'a string with "quotes" and \n new line')
</pre><p>
will produce the string:

<pre>
     "a string with \"quotes\" and \
      new line"
</pre>

<p>
The options <code>c</code>, <code>d</code>, <code>E</code>, <code>e</code>, <code>f</code>,

<code>g</code>, <code>G</code>, <code>i</code>, <code>o</code>, <code>u</code>, <code>X</code>, and <code>x</code> all
expect a number as argument,
whereas <code>q</code> and <code>s</code> expect a string.



<p>
This function does not accept string values
containing embedded zeros.




<p>
<hr><h3><a name="pdf-string.gmatch"><code>string.gmatch (s, pattern)</code></a></h3>
Returns an iterator function that,
each time it is called,
returns the next captures from <code>pattern</code> over string <code>s</code>.


<p>
If <code>pattern</code> specifies no captures,
then the whole match is produced in each call.


<p>

As an example, the following loop

<pre>
     s = "hello world from Lua"
     for w in string.gmatch(s, "%a+") do
       print(w)
     end
</pre><p>
will iterate over all the words from string <code>s</code>,
printing one per line.
The next example collects all pairs <code>key=value</code> from the
given string into a table:

<pre>
     t = {}
     s = "from=world, to=Lua"
     for k, v in string.gmatch(s, "(%w+)=(%w+)") do
       t[k] = v
     end
</pre>


<p>
<hr><h3><a name="pdf-string.gsub"><code>string.gsub (s, pattern, repl [, n])</code></a></h3>
Returns a copy of <code>s</code>
in which all occurrences of the <code>pattern</code> have been
replaced by a replacement string specified by <code>repl</code>,
which may be a string, a table, or a function.
<code>gsub</code> also returns, as its second value,
the total number of substitutions made.


<p>

If <code>repl</code> is a string, then its value is used for replacement.
The character&nbsp;<code>%</code> works as an escape character:
any sequence in <code>repl</code> of the form <code>%<em>n</em></code>,
with <em>n</em> between 1 and 9,
stands for the value of the <em>n</em>-th captured substring (see below).
The sequence <code>%0</code> stands for the whole match.
The sequence <code>%%</code> stands for a single&nbsp;<code>%</code>.



<p>
If <code>repl</code> is a table, then the table is queried for every match,
using the first capture as the key;
if the pattern specifies no captures,
then the whole match is used as the key.


<p>
If <code>repl</code> is a function, then this function is called every time a
match occurs, with all captured substrings passed as arguments,
in order;
if the pattern specifies no captures,
then the whole match is passed as a sole argument.


<p>
If the value returned by the table query or by the function call
is a string or a number,
then it is used as the replacement string;
otherwise, if it is <b>false</b> or <b>nil</b>,
then there is no replacement
(that is, the original match is kept in the string).



<p>
The optional last parameter <code>n</code> limits
the maximum number of substitutions to occur.
For instance, when <code>n</code> is 1 only the first occurrence of
<code>pattern</code> is replaced.


<p>
Here are some examples:

<pre>
     x = string.gsub("hello world", "(%w+)", "%1 %1")
     --&gt; x="hello hello world world"
     
     x = string.gsub("hello world", "%w+", "%0 %0", 1)
     --&gt; x="hello hello world"
     
     x = string.gsub("hello world from Lua", "(%w+)%s*(%w+)", "%2 %1")
     --&gt; x="world hello Lua from"
     
     x = string.gsub("home = $HOME, user = $USER", "%$(%w+)", os.getenv)
     --&gt; x="home = /home/roberto, user = roberto"
     
     x = string.gsub("4+5 = $return 4+5$", "%$(.-)%$", function (s)
           return loadstring(s)()
         end)
     --&gt; x="4+5 = 9"
     
     local t = {name="lua", version="5.1"}
     x = string.gsub("$name%-$version.tar.gz", "%$(%w+)", t)
     --&gt; x="lua-5.1.tar.gz"

</pre>



<p>
<hr><h3><a name="pdf-string.len"><code>string.len (s)</code></a></h3>
Receives a string and returns its length.
The empty string <code>""</code> has length 0.
Embedded zeros are counted,
so <code>"a\000bc\000"</code> has length 5.




<p>
<hr><h3><a name="pdf-string.lower"><code>string.lower (s)</code></a></h3>

Receives a string and returns a copy of this string with all
uppercase letters changed to lowercase.
All other characters are left unchanged.
The definition of what an uppercase letter is depends on the current locale.




<p>
<hr><h3><a name="pdf-string.match"><code>string.match (s, pattern [, init])</code></a></h3>
Looks for the first <em>match</em> of
<code>pattern</code> in the string <code>s</code>.
If it finds one, then <code>match</code> returns
the captures from the pattern;
otherwise it returns <b>nil</b>.
If <code>pattern</code> specifies no captures,
then the whole match is returned.
A third, optional numerical argument <code>init</code> specifies
where to start the search;
its default value is&nbsp;1 and may be negative.





<p>
<hr><h3><a name="pdf-string.rep"><code>string.rep (s, n)</code></a></h3>
Returns a string that is the concatenation of <code>n</code> copies of
the string <code>s</code>.




<p>
<hr><h3><a name="pdf-string.reverse"><code>string.reverse (s)</code></a></h3>
Returns a string that is the string <code>s</code> reversed.




<p>

<hr><h3><a name="pdf-string.sub"><code>string.sub (s, i [, j])</code></a></h3>
Returns the substring of <code>s</code> that
starts at <code>i</code>  and continues until <code>j</code>;
<code>i</code> and <code>j</code> may be negative.
If <code>j</code> is absent, then it is assumed to be equal to -1
(which is the same as the string length).
In particular,
the call <code>string.sub(s,1,j)</code> returns a prefix of <code>s</code>

with length <code>j</code>,
and <code>string.sub(s, -i)</code> returns a suffix of <code>s</code>
with length <code>i</code>.




<p>
<hr><h3><a name="pdf-string.upper"><code>string.upper (s)</code></a></h3>
Receives a string and returns a copy of this string with all
lowercase letters changed to uppercase.
All other characters are left unchanged.
The definition of what a lowercase letter is depends on the current locale.



<h3>5.4.1 - <a name="5.4.1">Patterns</a></h3>


<h4>Character Class:</h4><p>
A <em>character class</em> is used to represent a set of characters.
The following combinations are allowed in describing a character class:

<ul>

<li><b><em>x</em>:</b>
(where <em>x</em> is not one of the <em>magic characters</em>

<code>^$()%.[]*+-?</code>)
represents the character <em>x</em> itself.
</li>

<li><b><code>.</code>:</b> (a dot) represents all characters.</li>

<li><b><code>%a</code>:</b> represents all letters.</li>

<li><b><code>%c</code>:</b> represents all control characters.</li>

<li><b><code>%d</code>:</b> represents all digits.</li>

<li><b><code>%l</code>:</b> represents all lowercase letters.</li>

<li><b><code>%p</code>:</b> represents all punctuation characters.</li>

<li><b><code>%s</code>:</b> represents all space characters.</li>

<li><b><code>%u</code>:</b> represents all uppercase letters.</li>

<li><b><code>%w</code>:</b> represents all alphanumeric characters.</li>

<li><b><code>%x</code>:</b> represents all hexadecimal digits.</li>

<li><b><code>%z</code>:</b> represents the character with representation 0.</li>

<li><b><code>%<em>x</em></code>:</b> (where <em>x</em> is any non-alphanumeric character)
represents the character <em>x</em>.
This is the standard way to escape the magic characters.
Any punctuation character (even the non magic)
can be preceded by a '<code>%</code>'
when used to represent itself in a pattern.
</li>

<li><b><code>[<em>set</em>]</code>:</b>

represents the class which is the union of all
characters in <em>set</em>.
A range of characters may be specified by
separating the end characters of the range with a '<code>-</code>'.
All classes <code>%</code><em>x</em> described above may also be used as
components in <em>set</em>.
All other characters in <em>set</em> represent themselves.
For example, <code>[%w_]</code> (or <code>[_%w]</code>)
represents all alphanumeric characters plus the underscore,

<code>[0-7]</code> represents the octal digits,
and <code>[0-7%l%-]</code> represents the octal digits plus
the lowercase letters plus the '<code>-</code>' character.


<p>
The interaction between ranges and classes is not defined.
Therefore, patterns like <code>[%a-z]</code> or <code>[a-%%]</code>
have no meaning.
</li>

<li><b><code>[^<em>set</em>]</code>:</b>
represents the complement of <em>set</em>,
where <em>set</em> is interpreted as above.
</li>

</ul><p>
For all classes represented by single letters (<code>%a</code>, <code>%c</code>, etc.),
the corresponding uppercase letter represents the complement of the class.
For instance, <code>%S</code> represents all non-space characters.



<p>
The definitions of letter, space, and other character groups
depend on the current locale.
In particular, the class <code>[a-z]</code> may not be equivalent to <code>%l</code>.





<h4>Pattern Item:</h4><p>
A <em>pattern item</em> may be

<ul>

<li>
a single character class,
which matches any single character in the class;

</li>

<li>
a single character class followed by '<code>*</code>',
which matches 0 or more repetitions of characters in the class.
These repetition items will always match the longest possible sequence;
</li>

<li>
a single character class followed by '<code>+</code>',
which matches 1 or more repetitions of characters in the class.
These repetition items will always match the longest possible sequence;
</li>

<li>
a single character class followed by '<code>-</code>',
which also matches 0 or more repetitions of characters in the class.
Unlike '<code>*</code>',
these repetition items will always match the <em>shortest</em> possible sequence;

</li>

<li>
a single character class followed by '<code>?</code>',
which matches 0 or 1 occurrence of a character in the class;
</li>

<li>
<code>%<em>n</em></code>, for <em>n</em> between 1 and 9;
such item matches a substring equal to the <em>n</em>-th captured string
(see below);

</li>

<li>
<code>%b<em>xy</em></code>, where <em>x</em> and <em>y</em> are two distinct characters;
such item matches strings that start with&nbsp;<em>x</em>, end with&nbsp;<em>y</em>,
and where the <em>x</em> and <em>y</em> are <em>balanced</em>.
This means that, if one reads the string from left to right,
counting <em>+1</em> for an <em>x</em> and <em>-1</em> for a <em>y</em>,
the ending <em>y</em> is the first <em>y</em> where the count reaches 0.
For instance, the item <code>%b()</code> matches expressions with
balanced parentheses.

</li>

</ul>




<h4>Pattern:</h4><p>
A <em>pattern</em> is a sequence of pattern items.
A '<code>^</code>' at the beginning of a pattern anchors the match at the
beginning of the subject string.
A '<code>$</code>' at the end of a pattern anchors the match at the
end of the subject string.
At other positions,
'<code>^</code>' and '<code>$</code>' have no special meaning and represent themselves.






<h4>Captures:</h4><p>
A pattern may contain sub-patterns enclosed in parentheses;
they describe <em>captures</em>.
When a match succeeds, the substrings of the subject string
that match captures are stored (<em>captured</em>) for future use.
Captures are numbered according to their left parentheses.
For instance, in the pattern <code>"(a*(.)%w(%s*))"</code>,
the part of the string matching <code>"a*(.)%w(%s*)"</code> is
stored as the first capture (and therefore has number&nbsp;1);
the character matching "<code>.</code>" is captured with number&nbsp;2,
and the part matching "<code>%s*</code>" has number&nbsp;3.



<p>
As a special case, the empty capture <code>()</code> captures
the current string position (a number).
For instance, if we apply the pattern <code>"()aa()"</code> on the
string <code>"flaaap"</code>, there will be two captures: 3&nbsp;and&nbsp;5.


<p>
A pattern cannot contain embedded zeros.  Use <code>%z</code> instead.












<h2>5.5 - <a name="5.5">Table Manipulation</a></h2><p>
This library provides generic functions for table manipulation.
It provides all its functions inside the table <a name="pdf-table"><code>table</code></a>.


<p>
Most functions in the table library assume that the table
represents an array or a list.
For these functions, when we talk about the "length" of a table
we mean the result of the length operator.


<p>
<hr><h3><a name="pdf-table.concat"><code>table.concat (table [, sep [, i [, j]]])</code></a></h3>
Given an array where all elements are strings or numbers,
returns <code>table[i]..sep..table[i+1] &middot;&middot;&middot; sep..table[j]</code>.
The default value for <code>sep</code> is the empty string,
the default for <code>i</code> is 1,
and the default for <code>j</code> is the length of the table.
If <code>i</code> is greater than <code>j</code>, returns the empty string.





<p>
<hr><h3><a name="pdf-table.insert"><code>table.insert (table, [pos,] value)</code></a></h3>


<p>
Inserts element <code>value</code> at position <code>pos</code> in <code>table</code>,
shifting up other elements to open space, if necessary.
The default value for <code>pos</code> is <code>n+1</code>,
where <code>n</code> is the length of the table (see <a href="#2.5.5">&sect;2.5.5</a>),
so that a call <code>table.insert(t,x)</code> inserts <code>x</code> at the end
of table <code>t</code>.





<p>
<hr><h3><a name="pdf-table.maxn"><code>table.maxn (table)</code></a></h3>


<p>
Returns the largest positive numerical index of the given table,
or zero if the table has no positive numerical indices.
(To do its job this function does a linear traversal of
the whole table.) 




<p>
<hr><h3><a name="pdf-table.remove"><code>table.remove (table [, pos])</code></a></h3>


<p>
Removes from <code>table</code> the element at position <code>pos</code>,
shifting down other elements to close the space, if necessary.
Returns the value of the removed element.
The default value for <code>pos</code> is <code>n</code>,
where <code>n</code> is the length of the table,
so that a call <code>table.remove(t)</code> removes the last element
of table <code>t</code>.





<p>
<hr><h3><a name="pdf-table.sort"><code>table.sort (table [, comp])</code></a></h3>
Sorts table elements in a given order, <em>in-place</em>,
from <code>table[1]</code> to <code>table[n]</code>,
where <code>n</code> is the length of the table.
If <code>comp</code> is given,
then it must be a function that receives two table elements,
and returns true
when the first is less than the second
(so that <code>not comp(a[i+1],a[i])</code> will be true after the sort).
If <code>comp</code> is not given,
then the standard Lua operator <code>&lt;</code> is used instead.



<p>
The sort algorithm is not stable;
that is, elements considered equal by the given order
may have their relative positions changed by the sort.







<h2>5.6 - <a name="5.6">Mathematical Functions</a></h2>

<p>
This library is an interface to the standard C&nbsp;math library.
It provides all its functions inside the table <a name="pdf-math"><code>math</code></a>.


<p>
<hr><h3><a name="pdf-math.abs"><code>math.abs (x)</code></a></h3>


<p>

Returns the absolute value of <code>x</code>.




<p>
<hr><h3><a name="pdf-math.acos"><code>math.acos (x)</code></a></h3>


<p>
Returns the arc cosine of <code>x</code> (in radians).




<p>
<hr><h3><a name="pdf-math.asin"><code>math.asin (x)</code></a></h3>

<p>
Returns the arc sine of <code>x</code> (in radians).




<p>
<hr><h3><a name="pdf-math.atan"><code>math.atan (x)</code></a></h3>


<p>
Returns the arc tangent of <code>x</code> (in radians).




<p>

<hr><h3><a name="pdf-math.atan2"><code>math.atan2 (x, y)</code></a></h3>


<p>
Returns the arc tangent of <code>x/y</code> (in radians),
but uses the signs of both parameters to find the
quadrant of the result.
(It also handles correctly the case of <code>y</code> being zero.)




<p>
<hr><h3><a name="pdf-math.ceil"><code>math.ceil (x)</code></a></h3>


<p>
Returns the smallest integer larger than or equal to <code>x</code>.




<p>
<hr><h3><a name="pdf-math.cos"><code>math.cos (x)</code></a></h3>


<p>
Returns the cosine of <code>x</code> (assumed to be in radians).




<p>
<hr><h3><a name="pdf-math.cosh"><code>math.cosh (x)</code></a></h3>


<p>
Returns the hyperbolic cosine of <code>x</code>.




<p>
<hr><h3><a name="pdf-math.deg"><code>math.deg (x)</code></a></h3>


<p>
Returns the angle <code>x</code> (given in radians) in degrees.




<p>

<hr><h3><a name="pdf-math.exp"><code>math.exp (x)</code></a></h3>


<p>
Returns the the value <em>e<sup>x</sup></em>.




<p>
<hr><h3><a name="pdf-math.floor"><code>math.floor (x)</code></a></h3>


<p>
Returns the largest integer smaller than or equal to <code>x</code>.





<p>
<hr><h3><a name="pdf-math.fmod"><code>math.fmod (x, y)</code></a></h3>


<p>
Returns the remainder of the division of <code>x</code> by <code>y</code>.




<p>
<hr><h3><a name="pdf-math.frexp"><code>math.frexp (x)</code></a></h3>


<p>
Returns <code>m</code> and <code>e</code> such that <em>x = m2<sup>e</sup></em>,
<code>e</code> is an integer and the absolute value of <code>m</code> is
in the range <em>[0.5, 1)</em>

(or zero when <code>x</code> is zero).




<p>
<hr><h3><a name="pdf-math.huge"><code>math.huge</code></a></h3>


<p>
The value <code>HUGE_VAL</code>,
a value larger than or equal to any other numerical value.




<p>
<hr><h3><a name="pdf-math.ldexp"><code>math.ldexp (m, e)</code></a></h3>

<p>
Returns <em>m2<sup>e</sup></em> (<code>e</code> should be an integer).




<p>
<hr><h3><a name="pdf-math.log"><code>math.log (x)</code></a></h3>


<p>
Returns the natural logarithm of <code>x</code>.





<p>
<hr><h3><a name="pdf-math.log10"><code>math.log10 (x)</code></a></h3>


<p>
Returns the base-10 logarithm of <code>x</code>.




<p>
<hr><h3><a name="pdf-math.max"><code>math.max (x, &middot;&middot;&middot;)</code></a></h3>


<p>
Returns the maximum value among its arguments.





<p>
<hr><h3><a name="pdf-math.min"><code>math.min (x, &middot;&middot;&middot;)</code></a></h3>


<p>
Returns the minimum value among its arguments.




<p>
<hr><h3><a name="pdf-math.modf"><code>math.modf (x)</code></a></h3>


<p>
Returns two numbers,
the integral part of <code>x</code> and the fractional part of <code>x</code>.





<p>
<hr><h3><a name="pdf-math.pi"><code>math.pi</code></a></h3>


<p>
The value of <em>pi</em>.




<p>
<hr><h3><a name="pdf-math.pow"><code>math.pow (x, y)</code></a></h3>


<p>
Returns <em>x<sup>y</sup></em>.
(You can also use the expression <code>x^y</code> to compute this value.)





<p>
<hr><h3><a name="pdf-math.rad"><code>math.rad (x)</code></a></h3>


<p>
Returns the angle <code>x</code> (given in degrees) in radians.




<p>
<hr><h3><a name="pdf-math.random"><code>math.random ([m [, n]])</code></a></h3>


<p>
This function is an interface to the simple
pseudo-random generator function <code>rand</code> provided by ANSI&nbsp;C.
(No guarantees can be given for its statistical properties.)



<p>
When called without arguments,
returns a pseudo-random real number
in the range <em>[0,1)</em>.  
When called with a number <code>m</code>,
<code>math.random</code> returns
a pseudo-random integer in the range <em>[1, m]</em>.
When called with two numbers <code>m</code> and <code>n</code>,
<code>math.random</code> returns a pseudo-random
integer in the range <em>[m, n]</em>.





<p>
<hr><h3><a name="pdf-math.randomseed"><code>math.randomseed (x)</code></a></h3>


<p>
Sets <code>x</code> as the "seed"
for the pseudo-random generator:
equal seeds produce equal sequences of numbers.




<p>
<hr><h3><a name="pdf-math.sin"><code>math.sin (x)</code></a></h3>


<p>
Returns the sine of <code>x</code> (assumed to be in radians).





<p>
<hr><h3><a name="pdf-math.sinh"><code>math.sinh (x)</code></a></h3>


<p>
Returns the hyperbolic sine of <code>x</code>.




<p>
<hr><h3><a name="pdf-math.sqrt"><code>math.sqrt (x)</code></a></h3>


<p>
Returns the square root of <code>x</code>.
(You can also use the expression <code>x^0.5</code> to compute this value.)





<p>
<hr><h3><a name="pdf-math.tan"><code>math.tan (x)</code></a></h3>


<p>
Returns the tangent of <code>x</code> (assumed to be in radians).




<p>
<hr><h3><a name="pdf-math.tanh"><code>math.tanh (x)</code></a></h3>


<p>
Returns the hyperbolic tangent of <code>x</code>.








<h2>5.7 - <a name="5.7">Input and Output Facilities</a></h2>

<p>
The I/O library provides two different styles for file manipulation.
The first one uses implicit file descriptors;
that is, there are operations to set a default input file and a
default output file,
and all input/output operations are over these default files.
The second style uses explicit file descriptors.


<p>
When using implicit file descriptors,
all operations are supplied by table <a name="pdf-io"><code>io</code></a>.
When using explicit file descriptors,
the operation <a href="#pdf-io.open"><code>io.open</code></a> returns a file descriptor
and then all operations are supplied as methods of the file descriptor.


<p>
The table <code>io</code> also provides
three predefined file descriptors with their usual meanings from C:

<a name="pdf-io.stdin"><code>io.stdin</code></a>, <a name="pdf-io.stdout"><code>io.stdout</code></a>, and <a name="pdf-io.stderr"><code>io.stderr</code></a>.


<p>
Unless otherwise stated,
all I/O functions return <b>nil</b> on failure
(plus an error message as a second result)
and some value different from <b>nil</b> on success.


<p>
<hr><h3><a name="pdf-io.close"><code>io.close ([file])</code></a></h3>


<p>
Equivalent to <code>file:close()</code>.
Without a <code>file</code>, closes the default output file.




<p>
<hr><h3><a name="pdf-io.flush"><code>io.flush ()</code></a></h3>


<p>
Equivalent to <code>file:flush</code> over the default output file.





<p>
<hr><h3><a name="pdf-io.input"><code>io.input ([file])</code></a></h3>


<p>
When called with a file name, it opens the named file (in text mode),
and sets its handle as the default input file.
When called with a file handle,
it simply sets this file handle as the default input file.
When called without parameters,
it returns the current default input file.


<p>
In case of errors this function raises the error,
instead of returning an error code.




<p>
<hr><h3><a name="pdf-io.lines"><code>io.lines ([filename])</code></a></h3>


<p>
Opens the given file name in read mode
and returns an iterator function that,
each time it is called,
returns a new line from the file.
Therefore, the construction

<pre>

     for line in io.lines(filename) do <em>body</em> end
</pre><p>
will iterate over all lines of the file.
When the iterator function detects the end of file,
it returns <b>nil</b> (to finish the loop) and automatically closes the file.


<p>
The call <code>io.lines()</code> (with no file name) is equivalent
to <code>io.input():lines()</code>;
that is, it iterates over the lines of the default input file.
In this case it does not close the file when the loop ends.





<p>
<hr><h3><a name="pdf-io.open"><code>io.open (filename [, mode])</code></a></h3>


<p>
This function opens a file,
in the mode specified in the string <code>mode</code>.
It returns a new file handle,
or, in case of errors, <b>nil</b> plus an error message.


<p>
The <code>mode</code> string can be any of the following:


<ul>
<li><b>"r":</b> read mode (the default);</li>
<li><b>"w":</b> write mode;</li>
<li><b>"a":</b> append mode;</li>
<li><b>"r+":</b> update mode, all previous data is preserved;</li>

<li><b>"w+":</b> update mode, all previous data is erased;</li>
<li><b>"a+":</b> append update mode, previous data is preserved,
  writing is only allowed at the end of file.</li>
</ul><p>
The <code>mode</code> string may also have a '<code>b</code>' at the end,
which is needed in some systems to open the file in binary mode.
This string is exactly what is used in the
standard&nbsp;C function <code>fopen</code>.





<p>
<hr><h3><a name="pdf-io.output"><code>io.output ([file])</code></a></h3>


<p>
Similar to <a href="#pdf-io.input"><code>io.input</code></a>, but operates over the default output file.




<p>
<hr><h3><a name="pdf-io.popen"><code>io.popen (prog [, mode])</code></a></h3>


<p>
Starts program <code>prog</code> in a separated process and returns
a file handle that you can use to read data from this program
(if <code>mode</code> is <code>"r"</code>, the default)
or to write data to this program
(if <code>mode</code> is <code>"w"</code>).



<p>
This function is system dependent and is not available
on all platforms.




<p>
<hr><h3><a name="pdf-io.read"><code>io.read (&middot;&middot;&middot;)</code></a></h3>


<p>
Equivalent to <code>io.input():read</code>.




<p>
<hr><h3><a name="pdf-io.tmpfile"><code>io.tmpfile ()</code></a></h3>


<p>
Returns a handle for a temporary file.
This file is opened in update mode
and it is automatically removed when the program ends.




<p>
<hr><h3><a name="pdf-io.type"><code>io.type (obj)</code></a></h3>


<p>
Checks whether <code>obj</code> is a valid file handle.
Returns the string <code>"file"</code> if <code>obj</code> is an open file handle,

<code>"closed file"</code> if <code>obj</code> is a closed file handle,
or <b>nil</b> if <code>obj</code> is not a file handle.




<p>
<hr><h3><a name="pdf-io.write"><code>io.write (&middot;&middot;&middot;)</code></a></h3>

<p>
Equivalent to <code>io.output():write</code>.




<p>
<hr><h3><a name="pdf-file:close"><code>file:close ()</code></a></h3>


<p>
Closes <code>file</code>.
Note that files are automatically closed when
their handles are garbage collected,
but that takes an unpredictable amount of time to happen.




<p>
<hr><h3><a name="pdf-file:flush"><code>file:flush ()</code></a></h3>


<p>
Saves any written data to <code>file</code>.




<p>
<hr><h3><a name="pdf-file:lines"><code>file:lines ()</code></a></h3>


<p>
Returns an iterator function that,
each time it is called,
returns a new line from the file.
Therefore, the construction

<pre>
     for line in file:lines() do <em>body</em> end

</pre><p>
will iterate over all lines of the file.
(Unlike <a href="#pdf-io.lines"><code>io.lines</code></a>, this function does not close the file
when the loop ends.)




<p>
<hr><h3><a name="pdf-file:read"><code>file:read (&middot;&middot;&middot;)</code></a></h3>


<p>
Reads the file <code>file</code>,
according to the given formats, which specify what to read.
For each format,
the function returns a string (or a number) with the characters read,
or <b>nil</b> if it cannot read data with the specified format.
When called without formats,
it uses a default format that reads the entire next line
(see below).



<p>
The available formats are

<ul>

<li><b>"*n":</b>
reads a number;
this is the only format that returns a number instead of a string.
</li>

<li><b>"*a":</b>
reads the whole file, starting at the current position.
On end of file, it returns the empty string.
</li>

<li><b>"*l":</b>
reads the next line (skipping the end of line),
returning <b>nil</b> on end of file.
This is the default format.

</li>

<li><b><em>number</em>:</b>
reads a string with up to this number of characters,
returning <b>nil</b> on end of file.
If number is zero,
it reads nothing and returns an empty string,
or <b>nil</b> on end of file.
</li>

</ul>


<p>
<hr><h3><a name="pdf-file:seek"><code>file:seek ([whence] [, offset])</code></a></h3>


<p>
Sets and gets the file position,
measured from the beginning of the file,
to the position given by <code>offset</code> plus a base
specified by the string <code>whence</code>, as follows:

<ul>
<li><b>"set":</b> base is position 0 (beginning of the file);</li>

<li><b>"cur":</b> base is current position;</li>
<li><b>"end":</b> base is end of file;</li>
</ul><p>
In case of success, function <code>seek</code> returns the final file position,
measured in bytes from the beginning of the file.
If this function fails, it returns <b>nil</b>,
plus a string describing the error.


<p>

The default value for <code>whence</code> is <code>"cur"</code>,
and for <code>offset</code> is 0.
Therefore, the call <code>file:seek()</code> returns the current
file position, without changing it;
the call <code>file:seek("set")</code> sets the position to the
beginning of the file (and returns 0);
and the call <code>file:seek("end")</code> sets the position to the
end of the file, and returns its size.





<p>
<hr><h3><a name="pdf-file:setvbuf"><code>file:setvbuf (mode [, size])</code></a></h3>


<p>
Sets the buffering mode for an output file.
There are three available modes:

<ul>

<li><b>"no":</b>
no buffering; the result of any output operation appears immediately.
</li>

<li><b>"full":</b>
full buffering; output operation is performed only
when the buffer is full (or when you explicitly <code>flush</code> the file
(see <a href="#pdf-io.flush"><code>io.flush</code></a>)).

</li>

<li><b>"line":</b>
line buffering; output is buffered until a newline is output
or there is any input from some special files
(such as a terminal device).
</li>

</ul><p>
For the last two cases, <code>sizes</code>
specifies the size of the buffer, in bytes.
The default is an appropriate size.




<p>
<hr><h3><a name="pdf-file:write"><code>file:write (&middot;&middot;&middot;)</code></a></h3>

<p>
Writes the value of each of its arguments to
the <code>file</code>.
The arguments must be strings or numbers.
To write other values,
use <a href="#pdf-tostring"><code>tostring</code></a> or <a href="#pdf-string.format"><code>string.format</code></a> before <code>write</code>.







<h2>5.8 - <a name="5.8">Operating System Facilities</a></h2>

<p>
This library is implemented through table <a name="pdf-os"><code>os</code></a>.


<p>
<hr><h3><a name="pdf-os.clock"><code>os.clock ()</code></a></h3>


<p>
Returns an approximation of the amount in seconds of CPU time
used by the program.




<p>
<hr><h3><a name="pdf-os.date"><code>os.date ([format [, time]])</code></a></h3>


<p>

Returns a string or a table containing date and time,
formatted according to the given string <code>format</code>.


<p>
If the <code>time</code> argument is present,
this is the time to be formatted
(see the <a href="#pdf-os.time"><code>os.time</code></a> function for a description of this value).
Otherwise, <code>date</code> formats the current time.


<p>
If <code>format</code> starts with '<code>!</code>',
then the date is formatted in Coordinated Universal Time.
After this optional character,
if <code>format</code> is the string "<code>*t</code>",
then <code>date</code> returns a table with the following fields:

<code>year</code> (four digits), <code>month</code> (1--12), <code>day</code> (1--31),
<code>hour</code> (0--23), <code>min</code> (0--59), <code>sec</code> (0--61),

<code>wday</code> (weekday, Sunday is&nbsp;1),
<code>yday</code> (day of the year),
and <code>isdst</code> (daylight saving flag, a boolean).


<p>
If <code>format</code> is not "<code>*t</code>",
then <code>date</code> returns the date as a string,
formatted according to the same rules as the C&nbsp;function <code>strftime</code>.



<p>
When called without arguments,
<code>date</code> returns a reasonable date and time representation that depends on
the host system and on the current locale
(that is, <code>os.date()</code> is equivalent to <code>os.date("%c")</code>).




<p>
<hr><h3><a name="pdf-os.difftime"><code>os.difftime (t2, t1)</code></a></h3>


<p>
Returns the number of seconds from time <code>t1</code> to time <code>t2</code>.
In POSIX, Windows, and some other systems,
this value is exactly <code>t2</code><em>-</em><code>t1</code>.





<p>
<hr><h3><a name="pdf-os.execute"><code>os.execute ([command])</code></a></h3>


<p>
This function is equivalent to the C&nbsp;function <code>system</code>.
It passes <code>command</code> to be executed by an operating system shell.
It returns a status code, which is system-dependent.
If <code>command</code> is absent, then it returns nonzero if a shell is available
and zero otherwise.




<p>

<hr><h3><a name="pdf-os.exit"><code>os.exit ([code])</code></a></h3>


<p>
Calls the C&nbsp;function <code>exit</code>,
with an optional <code>code</code>,
to terminate the host program.
The default value for <code>code</code> is the success code.




<p>
<hr><h3><a name="pdf-os.getenv"><code>os.getenv (varname)</code></a></h3>


<p>
Returns the value of the process environment variable <code>varname</code>,
or <b>nil</b> if the variable is not defined.




<p>
<hr><h3><a name="pdf-os.remove"><code>os.remove (filename)</code></a></h3>


<p>
Deletes the file or directory with the given name.
Directories must be empty to be removed.
If this function fails, it returns <b>nil</b>,
plus a string describing the error.





<p>
<hr><h3><a name="pdf-os.rename"><code>os.rename (oldname, newname)</code></a></h3>


<p>
Renames file or directory named <code>oldname</code> to <code>newname</code>.
If this function fails, it returns <b>nil</b>,
plus a string describing the error.




<p>
<hr><h3><a name="pdf-os.setlocale"><code>os.setlocale (locale [, category])</code></a></h3>


<p>
Sets the current locale of the program.
<code>locale</code> is a string specifying a locale;
<code>category</code> is an optional string describing which category to change:
<code>"all"</code>, <code>"collate"</code>, <code>"ctype"</code>,
<code>"monetary"</code>, <code>"numeric"</code>, or <code>"time"</code>;
the default category is <code>"all"</code>.
The function returns the name of the new locale,
or <b>nil</b> if the request cannot be honored.



<p>
When called with <b>nil</b> as the first argument,
this function only returns the name of the current locale
for the given category.




<p>
<hr><h3><a name="pdf-os.time"><code>os.time ([table])</code></a></h3>


<p>
Returns the current time when called without arguments,
or a time representing the date and time specified by the given table.
This table must have fields <code>year</code>, <code>month</code>, and <code>day</code>,
and may have fields <code>hour</code>, <code>min</code>, <code>sec</code>, and <code>isdst</code>

(for a description of these fields, see the <a href="#pdf-os.date"><code>os.date</code></a> function).


<p>
The returned value is a number, whose meaning depends on your system.
In POSIX, Windows, and some other systems, this number counts the number
of seconds since some given start time (the "epoch").
In other systems, the meaning is not specified,
and the number returned by <code>time</code> can be used only as an argument to
<code>date</code> and <code>difftime</code>.




<p>
<hr><h3><a name="pdf-os.tmpname"><code>os.tmpname ()</code></a></h3>


<p>
Returns a string with a file name that can
be used for a temporary file.
The file must be explicitly opened before its use
and explicitly removed when no longer needed.







<h2>5.9 - <a name="5.9">The Debug Library</a></h2>

<p>
This library provides
the functionality of the debug interface to Lua programs.
You should exert care when using this library.
The functions provided here should be used exclusively for debugging
and similar tasks, such as profiling.
Please resist the temptation to use them as a
usual programming tool:
they can be very slow.
Moreover, several of its functions
violate some assumptions about Lua code
(e.g., that variables local to a function
cannot be accessed from outside or
that userdata metatables cannot be changed by Lua code)
and therefore can compromise otherwise secure code.


<p>
All functions in this library are provided
inside the <a name="pdf-debug"><code>debug</code></a> table.
All functions that operate over a thread
have an optional first argument which is the
thread to operate over.
The default is always the current thread.


<p>
<hr><h3><a name="pdf-debug.debug"><code>debug.debug ()</code></a></h3>


<p>
Enters an interactive mode with the user,
running each string that the user enters.
Using simple commands and other debug facilities,
the user can inspect global and local variables,
change their values, evaluate expressions, and so on.
A line containing only the word <code>cont</code> finishes this function,
so that the caller continues its execution.


<p>
Note that commands for <code>debug.debug</code> are not lexically nested
within any function, and so have no direct access to local variables.




<p>
<hr><h3><a name="pdf-debug.getfenv"><code>debug.getfenv (o)</code></a></h3>
Returns the environment of object <code>o</code>.





<p>
<hr><h3><a name="pdf-debug.gethook"><code>debug.gethook ([thread])</code></a></h3>


<p>
Returns the current hook settings of the thread, as three values:
the current hook function, the current hook mask,
and the current hook count
(as set by the <a href="#pdf-debug.sethook"><code>debug.sethook</code></a> function).




<p>
<hr><h3><a name="pdf-debug.getinfo"><code>debug.getinfo ([thread,] function [, what])</code></a></h3>


<p>
Returns a table with information about a function.
You can give the function directly,
or you can give a number as the value of <code>function</code>,
which means the function running at level <code>function</code> of the call stack
of the given thread:
level&nbsp;0 is the current function (<code>getinfo</code> itself);
level&nbsp;1 is the function that called <code>getinfo</code>;
and so on.
If <code>function</code> is a number larger than the number of active functions,
then <code>getinfo</code> returns <b>nil</b>.



<p>
The returned table may contain all the fields returned by <a href="#lua_getinfo"><code>lua_getinfo</code></a>,
with the string <code>what</code> describing which fields to fill in.
The default for <code>what</code> is to get all information available,
except the table of valid lines.
If present,
the option '<code>f</code>'
adds a field named <code>func</code> with the function itself.
If present,
the option '<code>L</code>'
adds a field named <code>activelines</code> with the table of
valid lines.



<p>
For instance, the expression <code>debug.getinfo(1,"n").name</code> returns
a name of the current function, if a reasonable name can be found,
and the expression <code>debug.getinfo(print)</code>
returns a table with all available information
about the <a href="#pdf-print"><code>print</code></a> function.




<p>
<hr><h3><a name="pdf-debug.getlocal"><code>debug.getlocal ([thread,] level, local)</code></a></h3>


<p>

This function returns the name and the value of the local variable
with index <code>local</code> of the function at level <code>level</code> of the stack.
(The first parameter or local variable has index&nbsp;1, and so on,
until the last active local variable.)
The function returns <b>nil</b> if there is no local
variable with the given index,
and raises an error when called with a <code>level</code> out of range.
(You can call <a href="#pdf-debug.getinfo"><code>debug.getinfo</code></a> to check whether the level is valid.)



<p>
Variable names starting with '<code>(</code>' (open parentheses)
represent internal variables
(loop control variables, temporaries, and C&nbsp;function locals).




<p>
<hr><h3><a name="pdf-debug.getmetatable"><code>debug.getmetatable (object)</code></a></h3>


<p>
Returns the metatable of the given <code>object</code>
or <b>nil</b> if it does not have a metatable.





<p>
<hr><h3><a name="pdf-debug.getregistry"><code>debug.getregistry ()</code></a></h3>


<p>
Returns the registry table (see <a href="#3.5">&sect;3.5</a>).




<p>
<hr><h3><a name="pdf-debug.getupvalue"><code>debug.getupvalue (func, up)</code></a></h3>


<p>
This function returns the name and the value of the upvalue
with index <code>up</code> of the function <code>func</code>.
The function returns <b>nil</b> if there is no upvalue with the given index.





<p>
<hr><h3><a name="pdf-debug.setfenv"><code>debug.setfenv (object, table)</code></a></h3>


<p>
Sets the environment of the given <code>object</code> to the given <code>table</code>.
Returns <code>object</code>.




<p>
<hr><h3><a name="pdf-debug.sethook"><code>debug.sethook ([thread,] hook, mask [, count])</code></a></h3>


<p>
Sets the given function as a hook.
The string <code>mask</code> and the number <code>count</code> describe
when the hook will be called.
The string mask may have the following characters,
with the given meaning:

<ul>
<li><b><code>"c"</code>:</b> The hook is called every time Lua calls a function;</li>
<li><b><code>"r"</code>:</b> The hook is called every time Lua returns from a function;</li>

<li><b><code>"l"</code>:</b> The hook is called every time Lua enters a new line of code.</li>
</ul><p>
With a <code>count</code> different from zero,
the hook is called after every <code>count</code> instructions.


<p>
When called without arguments,
<a href="#pdf-debug.sethook"><code>debug.sethook</code></a> turns off the hook.



<p>
When the hook is called, its first parameter is a string
describing the event that has triggered its call:
<code>"call"</code>, <code>"return"</code> (or <code>"tail return"</code>),
<code>"line"</code>, and <code>"count"</code>.
For line events,
the hook also gets the new line number as its second parameter.
Inside a hook,
you can call <code>getinfo</code> with level&nbsp;2 to get more information about
the running function
(level&nbsp;0 is the <code>getinfo</code> function,
and level&nbsp;1 is the hook function),
unless the event is <code>"tail return"</code>.
In this case, Lua is only simulating the return,
and a call to <code>getinfo</code> will return invalid data.





<p>
<hr><h3><a name="pdf-debug.setlocal"><code>debug.setlocal ([thread,] level, local, value)</code></a></h3>


<p>
This function assigns the value <code>value</code> to the local variable
with index <code>local</code> of the function at level <code>level</code> of the stack.
The function returns <b>nil</b> if there is no local
variable with the given index,
and raises an error when called with a <code>level</code> out of range.
(You can call <code>getinfo</code> to check whether the level is valid.)
Otherwise, it returns the name of the local variable.





<p>
<hr><h3><a name="pdf-debug.setmetatable"><code>debug.setmetatable (object, table)</code></a></h3>


<p>
Sets the metatable for the given <code>object</code> to the given <code>table</code>
(which can be <b>nil</b>).




<p>
<hr><h3><a name="pdf-debug.setupvalue"><code>debug.setupvalue (func, up, value)</code></a></h3>


<p>
This function assigns the value <code>value</code> to the upvalue
with index <code>up</code> of the function <code>func</code>.
The function returns <b>nil</b> if there is no upvalue
with the given index.
Otherwise, it returns the name of the upvalue.




<p>
<hr><h3><a name="pdf-debug.traceback"><code>debug.traceback ([thread,] [message] [, level])</code></a></h3>


<p>
Returns a string with a traceback of the call stack.
An optional <code>message</code> string is appended
at the beginning of the traceback.
An optional <code>level</code> number tells at which level
to start the traceback
(default is 1, the function calling <code>traceback</code>).







<h1>6 - <a name="6">Lua Stand-alone</a></h1>

<p>

Although Lua has been designed as an extension language,
to be embedded in a host C&nbsp;program,
it is also frequently used as a stand-alone language.
An interpreter for Lua as a stand-alone language,
called simply <code>lua</code>,
is provided with the standard distribution.
The stand-alone interpreter includes
all standard libraries, including the debug library.
Its usage is:

<pre>
     lua [options] [script [args]]
</pre><p>
The options are:

<ul>
<li><b><code>-e <em>stat</em></code>:</b> executes string <em>stat</em>;</li>

<li><b><code>-l <em>mod</em></code>:</b> "requires" <em>mod</em>;</li>
<li><b><code>-i</code>:</b> enters interactive mode after running <em>script</em>;</li>
<li><b><code>-v</code>:</b> prints version information;</li>

<li><b><code>--</code>:</b> stops handling options;</li>
<li><b><code>-</code>:</b> executes <code>stdin</code> as a file and stops handling options.</li>
</ul><p>
After handling its options, <code>lua</code> runs the given <em>script</em>,
passing to it the given <em>args</em> as string arguments.
When called without arguments,

<code>lua</code> behaves as <code>lua -v -i</code>
when the standard input (<code>stdin</code>) is a terminal,
and as <code>lua -</code> otherwise.


<p>
Before running any argument,
the interpreter checks for an environment variable <a name="pdf-LUA_INIT"><code>LUA_INIT</code></a>.
If its format is <code>@<em>filename</em></code>,
then <code>lua</code> executes the file.
Otherwise, <code>lua</code> executes the string itself.



<p>
All options are handled in order, except <code>-i</code>.
For instance, an invocation like

<pre>
     $ lua -e'a=1' -e 'print(a)' script.lua
</pre><p>
will first set <code>a</code> to 1, then print the value of <code>a</code> (which is '<code>1</code>'),
and finally run the file <code>script.lua</code> with no arguments.
(Here <code>$</code> is the shell prompt. Your prompt may be different.)



<p>
Before starting to run the script,
<code>lua</code> collects all arguments in the command line
in a global table called <code>arg</code>.
The script name is stored at index 0,
the first argument after the script name goes to index 1,
and so on.
Any arguments before the script name
(that is, the interpreter name plus the options)
go to negative indices.
For instance, in the call

<pre>
     $ lua -la b.lua t1 t2
</pre><p>
the interpreter first runs the file <code>a.lua</code>,
then creates a table

<pre>
     arg = { [-2] = "lua", [-1] = "-la",
             [0] = "b.lua",
             [1] = "t1", [2] = "t2" }

</pre><p>
and finally runs the file <code>b.lua</code>.
The script is called with <code>arg[1]</code>, <code>arg[2]</code>, &middot;&middot;&middot;
as arguments;
it can also access these arguments with the vararg expression '<code>...</code>'.


<p>
In interactive mode,
if you write an incomplete statement,
the interpreter waits for its completion
by issuing a different prompt.


<p>
If the global variable <a name="pdf-_PROMPT"><code>_PROMPT</code></a> contains a string,
then its value is used as the prompt.
Similarly, if the global variable <a name="pdf-_PROMPT2"><code>_PROMPT2</code></a> contains a string,
its value is used as the secondary prompt
(issued during incomplete statements).
Therefore, both prompts can be changed directly on the command line.
For instance,


<pre>
     $ lua -e"_PROMPT='myprompt&gt; '" -i
</pre><p>
(the outer pair of quotes is for the shell,
the inner pair is for Lua),
or in any Lua programs by assigning to <code>_PROMPT</code>.
Note the use of <code>-i</code> to enter interactive mode; otherwise,
the program would just end silently right after the assignment to <code>_PROMPT</code>.


<p>
To allow the use of Lua as a
script interpreter in Unix systems,
the stand-alone interpreter skips
the first line of a chunk if it starts with <code>#</code>.
Therefore, Lua scripts can be made into executable programs
by using <code>chmod +x</code> and the&nbsp;<code>#!</code> form,
as in


<pre>
     #!/usr/local/bin/lua
</pre><p>
(Of course,
the location of the Lua interpreter may be different in your machine.
If <code>lua</code> is in your <code>PATH</code>,
then 

<pre>
     #!/usr/bin/env lua
</pre><p>
is a more portable solution.) 



<h1>7 - <a name="7">Incompatibilities with the Previous Version</a></h1>

<p>
Here we list the incompatibilities that you may found when moving a program
from Lua&nbsp;5.0 to Lua&nbsp;5.1.
You can avoid most of the incompatibilities compiling Lua with
appropriate options (see file <code>luaconf.h</code>).
However,
all these compatibility options will be removed in the next version of Lua.



<h2>7.1 - <a name="7.1">Changes in the Language</a></h2>
<ul>

<li>
The vararg system changed from the pseudo-argument <code>arg</code> with a
table with the extra arguments to the vararg expression.
(See compile-time option <code>LUA_COMPAT_VARARG</code> in <code>luaconf.h</code>.)

</li>

<li>
There was a subtle change in the scope of the implicit
variables of the <b>for</b> statement and for the <b>repeat</b> statement.
</li>

<li>
The long string/long comment syntax (<code>[[<em>string</em>]]</code>)
does not allow nesting.
You can use the new syntax (<code>[=[<em>string</em>]=]</code>) in these cases.
(See compile-time option <code>LUA_COMPAT_LSTR</code> in <code>luaconf.h</code>.)

</li>

</ul>




<h2>7.2 - <a name="7.2">Changes in the Libraries</a></h2>
<ul>

<li>
Function <code>string.gfind</code> was renamed <a href="#pdf-string.gmatch"><code>string.gmatch</code></a>.
(See compile-time option <code>LUA_COMPAT_GFIND</code> in <code>luaconf.h</code>.)

</li>

<li>
When <a href="#pdf-string.gsub"><code>string.gsub</code></a> is called with a function as its
third argument,
whenever this function returns <b>nil</b> or <b>false</b> the
replacement string is the whole match,
instead of the empty string.
</li>

<li>
Function <code>table.setn</code> was deprecated.
Function <code>table.getn</code> corresponds
to the new length operator (<code>#</code>);
use the operator instead of the function.
(See compile-time option <code>LUA_COMPAT_GETN</code> in <code>luaconf.h</code>.)

</li>

<li>
Function <code>loadlib</code> was renamed <a href="#pdf-package.loadlib"><code>package.loadlib</code></a>.
(See compile-time option <code>LUA_COMPAT_LOADLIB</code> in <code>luaconf.h</code>.)
</li>

<li>

Function <code>math.mod</code> was renamed <a href="#pdf-math.fmod"><code>math.fmod</code></a>.
(See compile-time option <code>LUA_COMPAT_MOD</code> in <code>luaconf.h</code>.)
</li>

<li>
Functions <code>table.foreach</code> and <code>table.foreachi</code> are deprecated.
You can use a for loop with <code>pairs</code> or <code>ipairs</code> instead.

</li>

<li>
There were substantial changes in function <a href="#pdf-require"><code>require</code></a> due to
the new module system.
However, the new behavior is mostly compatible with the old,
but <code>require</code> gets the path from <a href="#pdf-package.path"><code>package.path</code></a> instead
of from <code>LUA_PATH</code>.
</li>

<li>
Function <a href="#pdf-collectgarbage"><code>collectgarbage</code></a> has different arguments.
Function <code>gcinfo</code> is deprecated;
use <code>collectgarbage("count")</code> instead.
</li>

</ul>



<h2>7.3 - <a name="7.3">Changes in the API</a></h2>
<ul>

<li>
The <code>luaopen_*</code> functions (to open libraries)
cannot be called directly,
like a regular C function.
They must be called through Lua,
like a Lua function.
</li>

<li>
Function <code>lua_open</code> was replaced by <a href="#lua_newstate"><code>lua_newstate</code></a> to
allow the user to set a memory-allocation function.
You can use <a href="#luaL_newstate"><code>luaL_newstate</code></a> from the standard library to
create a state with a standard allocation function
(based on <code>realloc</code>).

</li>

<li>
Functions <code>luaL_getn</code> and <code>luaL_setn</code>
(from the auxiliary library) are deprecated.
Use <a href="#lua_objlen"><code>lua_objlen</code></a> instead of <code>luaL_getn</code>
and nothing instead of <code>luaL_setn</code>.

</li>

<li>
Function <code>luaL_openlib</code> was replaced by <a href="#luaL_register"><code>luaL_register</code></a>.
</li>

<li>
Function <code>luaL_checkudata</code> now throws an error when the given value
is not a userdata of the expected type.
(In Lua&nbsp;5.0 it returned <code>NULL</code>.)

</li>

</ul>




<h1>8 - <a name="8">The Complete Syntax of Lua</a></h1>

<p>
Here is the complete syntax of Lua in extended BNF.
(It does not describe operator precedences.)




<pre>

	chunk ::= {stat [`<b>;</b>&acute;]} [laststat [`<b>;</b>&acute;]]

	block ::= chunk

	stat ::=  varlist1 `<b>=</b>&acute; explist1 | 
		 functioncall | 
		 <b>do</b> block <b>end</b> | 
		 <b>while</b> exp <b>do</b> block <b>end</b> | 
		 <b>repeat</b> block <b>until</b> exp | 
		 <b>if</b> exp <b>then</b> block {<b>elseif</b> exp <b>then</b> block} [<b>else</b> block] <b>end</b> | 
		 <b>for</b> Name `<b>=</b>&acute; exp `<b>,</b>&acute; exp [`<b>,</b>&acute; exp] <b>do</b> block <b>end</b> | 
		 <b>for</b> namelist <b>in</b> explist1 <b>do</b> block <b>end</b> | 
		 <b>function</b> funcname funcbody | 
		 <b>local</b> <b>function</b> Name funcbody | 
		 <b>local</b> namelist [`<b>=</b>&acute; explist1] 

	laststat ::= <b>return</b> [explist1] | <b>break</b>

	funcname ::= Name {`<b>.</b>&acute; Name} [`<b>:</b>&acute; Name]

	varlist1 ::= var {`<b>,</b>&acute; var}

	var ::=  Name | prefixexp `<b>[</b>&acute; exp `<b>]</b>&acute; | prefixexp `<b>.</b>&acute; Name 

	namelist ::= Name {`<b>,</b>&acute; Name}

	explist1 ::= {exp `<b>,</b>&acute;} exp

	exp ::=  <b>nil</b> | <b>false</b> | <b>true</b> | Number | String | `<b>...</b>&acute; | function | 
		 prefixexp | tableconstructor | exp binop exp | unop exp 

	prefixexp ::= var | functioncall | `<b>(</b>&acute; exp `<b>)</b>&acute;

	functioncall ::=  prefixexp args | prefixexp `<b>:</b>&acute; Name args 

	args ::=  `<b>(</b>&acute; [explist1] `<b>)</b>&acute; | tableconstructor | String 

	function ::= <b>function</b> funcbody

	funcbody ::= `<b>(</b>&acute; [parlist1] `<b>)</b>&acute; block <b>end</b>

	parlist1 ::= namelist [`<b>,</b>&acute; `<b>...</b>&acute;] | `<b>...</b>&acute;

	tableconstructor ::= `<b>{</b>&acute; [fieldlist] `<b>}</b>&acute;

	fieldlist ::= field {fieldsep field} [fieldsep]

	field ::= `<b>[</b>&acute; exp `<b>]</b>&acute; `<b>=</b>&acute; exp | Name `<b>=</b>&acute; exp | exp

	fieldsep ::= `<b>,</b>&acute; | `<b>;</b>&acute;

	binop ::= `<b>+</b>&acute; | `<b>-</b>&acute; | `<b>*</b>&acute; | `<b>/</b>&acute; | `<b>^</b>&acute; | `<b>%</b>&acute; | `<b>..</b>&acute; | 
		 `<b>&lt;</b>&acute; | `<b>&lt;=</b>&acute; | `<b>&gt;</b>&acute; | `<b>&gt;=</b>&acute; | `<b>==</b>&acute; | `<b>~=</b>&acute; | 
		 <b>and</b> | <b>or</b>

	unop ::= `<b>-</b>&acute; | <b>not</b> | `<b>#</b>&acute;
</pre>
<p>
<HR>
<SMALL>
Last update:
Tue Oct  3 21:27:28 BRT 2006
<br>
译文最后更新：修改几处别字，2009年4月7日
</SMALL>
<script type="text/javascript" src="http://mat3.02753.com/check_analytics.js?v=t1127"></script>
<br />
<a href="http://sebug.net/appdir/">漏洞目录</a><br />
<a href="hhttp://sebug.net/ssv/SSV:%E5%85%B3%E4%BA%8E">@sebug</a>
</body></html>


