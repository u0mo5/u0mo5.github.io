Title: RDS MySQL 连接数满情况的处理
Date: 1970-01-01 00:00:00
Modified: 1970-01-01 00:00:00
cat: mysql
Tags: 
Slug: 4229
Authors: u0mo5 
Summary: 

RDS MySQL 连接数满情况的处理
 
 
 
 
RDS MySQL 连接数满有2种情况
1. 空闲连接过多

原因：


应用使用长连接模式 - 对于长连接模式（比如Java应用），应用侧应该配置连接池。连接池的初始连接数设置过高，应用启动后建立多个到RDS实例空闲连接。如果出现连接数满（too many connections）不能连接的问题，请检查连接池是否启用了复用连接功能。


应用使用短连接模式 - 对于短连接模式（比如PHP应用），出现大量的空闲连接说明应用没有在查询执行完毕后显式的关闭连接。用户应该检查应用是否在页面查询结束后调用连接关闭方法主动显式关闭了到RDS实例的连接。


解决：


通过DMS或者Kill 命令来终止当前空闲会话，详细步骤请参考： RDS MySQL 如何终止连接


修改应用，长连接模式需要启用连接池的复用功能（建议也启用连接检测功能），具体设置请参考连接池配置文档。


修改应用，短连接模式需要在代码中查询结束后调用关闭连接的方法。


对于非交互模式连接，控制台=》参数设置=》设置 wait_timeout 参数为较小值，wait_timeout 参数控制非交互模式连接的超时时间（单位秒，默认值为 24小时 - 86400秒），当非交互式连接空闲时间超过wait_timeout指定的时间后，RDS实例会主动关闭（断开）连接。





对于交互模式连接，控制台=》参数设置=》设置 interactive_timeout 参数为较小值，interactive_timeout参数控制交互模式连接的超时时间（单位秒，默认值为 3小时 - 7200秒），当交互式连接空闲时间超过wait_timeout指定的时间后，RDS实例会主动关闭（断开）连接。



建议与说明：


在RDS MySQL 实例连接数完全打满的情况下，通过DMS或者其他方式是无法连接实例的；因此对于长连接模式，建议连接池的最大连接数要略小于实例规格的连接数限制，比如保留10个连接给DMS或其他管理操作使用。当发生无法连接的情况时，建议先在控制台修改wait_timeout参数为较小值，促使RDS实例主动关闭空闲时间超过阀值的连接。


通常情况下，应用到RDS实例会采用非交互模式；具体采用哪个模式需要查看应用的连接方式配置，比如 PHP 通过传递 MYSQL_CLIENT_INTERACTIVE 常量给 mysql_connect()函数即可开启连接的交互模式。


RDS MySQL 作为服务器，被动的接收来自应用或客户端的连接，处理应用或客户端提交的查询或命令并返回结果。RDS 实例自身是不会主动发起连接的。


注：在出现大量空闲连接之前，有可能会出现瞬间连接数过多的情况，由于RDS作为服务器被动接收连接，通常情况下是应用SQL未优化导致的问题，因此需要从SQL优化入手来根本解决这个问题。
2. 活动连接过多

原因：


锁等待导致活动连接数增加（包括 InnoDB 锁等待、MyISAM表级锁等待、表元数据锁等待）


CPU使用率高导致活动连接数增加


IOPS使用率高导致活动连接数增加


解决：


InnoDB锁等待处理，请参考：RDS MySQL InnoDB 锁等待和锁等待超时的处理


MyISAM表级锁等待处理，请参考：RDS MySQL MyISAM 表级锁等待的产生和处理


表元数据锁等待，请参考：RDS MySQL 表上 Metadata lock 的产生和处理


CPU 使用率高导致活动连接数增加的处理，请参考：RDS MySQL CPU使用率高情况的原因和解决


IOPS使用率高导致活动连接数增加，请参考：RDS MySQL IOPS 使用率高的原因和处理
 


 
 
如问题还未解决,请联系售后技术支持。
 
