Title: Java实现图片内容无损任意角度旋转
Date: 1970-01-01 00:00:00
Modified: 1970-01-01 00:00:00
cat: java
Tags: 
Slug: 3751
Authors: u0mo5 
Summary: 

转自：http://blog.csdn.net/heliang7/article/details/7309394
主要问题是如何在图片做旋转后计算出新图片的长宽。
在java 2d和基本math库的帮助下，其实利用简单的计算就可以知道。

以下算法只是计算出旋转小于90度时的公式。当旋转大于90时，可以先把问题域换算到锐角的情况，再进行计算即可。
如下图所示，需要计算出来的是len_delta的长度，就是有双竖线的位置，它是新图片要增加的宽。（要增加的高度同理可得。）
其实只要知道len的长度，还有len和len_delta的夹角，就可以算出len_delta的长度了。
1. len的长度。注意到它是等腰三角形的底边，顶角为angel， 容易得到len=2*R*sin(angel/2)
2. len和len_delta的夹角。先可以计算出angel_alpha，也就是等腰三角形的底角 angel_alpha = (PI - angel) / 2
    然后是R和原图像的底边的夹角angel_delta，显然其tan值是原图片的高宽比（注意计算增加的高度时是宽高比）。用arctan求出其角度。
    len和len_delta的夹角 = PI - angel_alpha - angel_delta
3. len_delta = len * cos(len和len_delta的夹角)



java代码示例如下


[java] view plaincopy




&lt;pre name="code" class="java"&gt;import java.awt.Dimension;  

import java.awt.Graphics2D;  
import java.awt.Image;  
import java.awt.Rectangle;  
import java.awt.image.BufferedImage;  
  
public class RotateImage {  
  
    public static BufferedImage Rotate(Image src, int angel) {  

        int src_width = src.getWidth(null);  

        int src_height = src.getHeight(null);  

        // calculate the new image size  

        Rectangle rect_des = CalcRotatedSize(new Rectangle(new Dimension(  

                src_width, src_height)), angel);  
  
        BufferedImage res = null;  

        res = new BufferedImage(rect_des.width, rect_des.height,  

                BufferedImage.TYPE_INT_RGB);  
        Graphics2D g2 = res.createGraphics();  
        // transform  

        g2.translate((rect_des.width - src_width) / 2,  

                (rect_des.height - src_height) / 2);  

        g2.rotate(Math.toRadians(angel), src_width / 2, src_height / 2);  

  
        g2.drawImage(src, null, null);  

        return res;  

    }  
  
    public static Rectangle CalcRotatedSize(Rectangle src, int angel) {  

        // if angel is greater than 90 degree, we need to do some conversion  

        if (angel &gt;= 90) {  

            if(angel / 90 % 2 == 1){  

                int temp = src.height;  

                src.height = src.width;  
                src.width = temp;  
            }  
            angel = angel % 90;  

        }  
  
        double r = Math.sqrt(src.height * src.height + src.width * src.width) / 2;  

        double len = 2 * Math.sin(Math.toRadians(angel) / 2) * r;  

        double angel_alpha = (Math.PI - Math.toRadians(angel)) / 2;  

        double angel_dalta_width = Math.atan((double) src.height / src.width);  

        double angel_dalta_height = Math.atan((double) src.width / src.height);  

  
        int len_dalta_width = (int) (len * Math.cos(Math.PI - angel_alpha  

                - angel_dalta_width));  
        int len_dalta_height = (int) (len * Math.cos(Math.PI - angel_alpha  

                - angel_dalta_height));  
        int des_width = src.width + len_dalta_width * 2;  

        int des_height = src.height + len_dalta_height * 2;  

        return new java.awt.Rectangle(new Dimension(des_width, des_height));  

    }  
}&lt;/pre&gt;&lt;br&gt;  
&lt;pre&gt;&lt;/pre&gt;  
&lt;p&gt;JUnit测试代码如下，将图片路径改为你自己准备测试用的图片路径即可。&lt;/p&gt;  
&lt;p&gt;&lt;/p&gt;  
&lt;pre name="code" class="java"&gt;&lt;pre name="code" class="java"&gt;import java.awt.image.BufferedImage;  

import java.io.File;  
import java.io.IOException;  
  
import javax.imageio.ImageIO;  
  
import junit.framework.Assert;  
  
import org.junit.Test;  
  
import Jugnoo.RotateImage;  
  
public class RotateImageTest {  
  
    @Test  

    public void testRotate() throws IOException {  

  
        BufferedImage src = ImageIO.read(new File("d:/dog.jpg"));  

        BufferedImage des = RotateImage.Rotate(src, 30);  

        Assert.assertNotNull(des);  
        Assert.assertTrue(ImageIO.write(des, "jpg", new File("d:/dog2.jpg")));  

  
        // bigger angel  

        des = RotateImage.Rotate(src, 150);  

        Assert.assertNotNull(des);  
        Assert.assertTrue(ImageIO.write(des, "jpg", new File("d:/dog3.jpg")));  

  
        // bigger angel  

        des = RotateImage.Rotate(src, 270);  

        Assert.assertNotNull(des);  
        Assert.assertTrue(ImageIO.write(des, "jpg", new File("d:/dog4.jpg")));  

  
    }  
  
}&lt;/pre&gt;&lt;br&gt;  
&lt;br&gt;  
&lt;pre&gt;&lt;/pre&gt;  
&lt;p&gt;&lt;/p&gt;  
&lt;pre&gt;&lt;/pre&gt;  
&lt;pre&gt;&lt;/pre&gt;  
  



