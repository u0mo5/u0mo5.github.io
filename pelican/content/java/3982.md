Title: logback
Date: 1970-01-01 00:00:00
Modified: 1970-01-01 00:00:00
cat: default
Tags: 
Slug: 3982
Authors: u0mo5 
Summary: 


 



新的公司日志管理统一用logback，由于之前一直在用log4j，所以其实对logback这个由log4j长出来的家伙还不算陌生。
 
首先介绍下logback的前世今生。
 
slf4j由log4j作者Ceki开发，逐步取代apahce commons logging。
logback由log4j作者Ceki开发，逐步取代log4j。
slf4j等于commons-logging，是各种日志实现的通用入口，会根据classpath中存在下面哪一个Jar来决定具体的日志实现库。
 
logback相比较log4j的优势
slf4j支持参数化的logger.error("帐号ID：{}不存在", userId);
告别了if(logger.isDebugEnable()) 时代。
另外logback的整体性能比log4j也较佳，hibernate等项目已经采用了slf4j。
 
slf4j和logback的使用
1.如果日志的参数超过3个，需要写成
 
 


Java代码  



Object[] params = {newVal, below, above};  
logger.debug("Value {} was inserted between {} and {}.", params);  



 
2.因为内部已优化，作者认为slf4j的logger不需要定义为static。
3.可设置缓存后批量写日志文件(但服务器如果重启，可能会丢失未写到磁盘的记录)
4.MDC，用Filter，将当前用户名等业务信息放入MDC中，在日志format定义中即可使用该变量。
5.JMS Appender用于告警, DB Appender用于业务日志等可以使用插件，如生成Log代码的Eclipse插件Log4E。
6.tomcat和glassfish中，设定日志路径为../logs/xxxx.log 都能将日志放入应用服务器本身的logs目录。
 
最后把最近完善的一个logback.xml贴上，毕竟实际项目中的文件最能说明问题。
 
 


Xml代码  



&lt;?xml version="1.0" encoding="UTF-8"?&gt;  
  
&lt;configuration&gt;  
    &lt;substitutionProperty name="log.base" value="d:logbacklogback" /&gt;  

    &lt;jmxConfigurator /&gt;  

    &lt;appender name="stdout" class="ch.qos.logback.core.ConsoleAppender"&gt;  

        &lt;filter class="ch.qos.logback.core.filter.EvaluatorFilter"&gt;  

            &lt;evaluator name="myEval"&gt;  

                &lt;expression&gt;message.contains("dao")&lt;/expression&gt;  

            &lt;/evaluator&gt;  

            &lt;onMatch&gt;ACCEPT&lt;/onMatch&gt;  

            &lt;onMismatch&gt;DENY&lt;/onMismatch&gt;  

        &lt;/filter&gt;  

        &lt;layout class="ch.qos.logback.classic.PatternLayout"&gt;  

            &lt;pattern&gt;%date [%thread] %-5level %logger{80} - %msg%n&lt;/pattern&gt;  

        &lt;/layout&gt;  

    &lt;/appender&gt;  

    &lt;appender name="logfile-dao"  

        class="ch.qos.logback.core.rolling.RollingFileAppender"&gt;  

        &lt;filter class="ch.qos.logback.core.filter.EvaluatorFilter"&gt;  

            &lt;evaluator name="myEval_dao"&gt;  

                &lt;expression&gt;message.contains("dao")&lt;/expression&gt;  

            &lt;/evaluator&gt;  

            &lt;onMatch&gt;ACCEPT&lt;/onMatch&gt;  

            &lt;onMismatch&gt;DENY&lt;/onMismatch&gt;  

        &lt;/filter&gt;  

        &lt;Encoding&gt;UTF-8&lt;/Encoding&gt;  

        &lt;File&gt;${log.base}_dao.log&lt;/File&gt;  

        &lt;rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy"&gt;  

            &lt;FileNamePattern&gt;${log.base}.%d{yyyy-MM-dd}_dao.log.zip  

            &lt;/FileNamePattern&gt;  

        &lt;/rollingPolicy&gt;  

        &lt;layout class="ch.qos.logback.classic.PatternLayout"&gt;  

            &lt;pattern&gt;%date [%thread] %-5level %logger{80} - %msg%n&lt;/pattern&gt;  

        &lt;/layout&gt;  

    &lt;/appender&gt;  

    &lt;appender name="logfile-service"  

        class="ch.qos.logback.core.rolling.RollingFileAppender"&gt;  

        &lt;filter class="ch.qos.logback.core.filter.EvaluatorFilter"&gt;  

            &lt;evaluator name="myEval_service"&gt;  

                &lt;expression&gt;message.contains("service.impl")&lt;/expression&gt;  

            &lt;/evaluator&gt;  

            &lt;onMatch&gt;ACCEPT&lt;/onMatch&gt;  

            &lt;onMismatch&gt;DENY&lt;/onMismatch&gt;  

        &lt;/filter&gt;  

        &lt;Encoding&gt;UTF-8&lt;/Encoding&gt;  

        &lt;File&gt;${log.base}_service.log&lt;/File&gt;  

        &lt;rollingPolicy class="ch.qos.logback.core.rolling.TimeBasedRollingPolicy"&gt;  

            &lt;FileNamePattern&gt;${log.base}.%d{yyyy-MM-dd}_service.log.zip  

            &lt;/FileNamePattern&gt;  

        &lt;/rollingPolicy&gt;  

        &lt;layout class="ch.qos.logback.classic.PatternLayout"&gt;  

            &lt;pattern&gt;%date [%thread] %-5level %logger{80} - %msg%n&lt;/pattern&gt;  

        &lt;/layout&gt;  

    &lt;/appender&gt;  

    &lt;appender name="jms_dao" class="ch.qos.logback.classic.net.JMSQueueAppender"&gt;  

        &lt;InitialContextFactoryName&gt;  

            org.apache.activemq.jndi.ActiveMQInitialContextFactory  
        &lt;/InitialContextFactoryName&gt;  

        &lt;ProviderURL&gt;tcp://192.168.1.120:61616&lt;/ProviderURL&gt;  

        &lt;filter class="ch.qos.logback.core.filter.EvaluatorFilter"&gt;  

            &lt;evaluator name="myEval_service"&gt;  

                &lt;expression&gt;message.contains("dao")&lt;/expression&gt;  

            &lt;/evaluator&gt;  

            &lt;onMatch&gt;ACCEPT&lt;/onMatch&gt;  

            &lt;onMismatch&gt;DENY&lt;/onMismatch&gt;  

        &lt;/filter&gt;  

        &lt;QueueConnectionFactoryBindingName&gt;ConnectionFactory  

        &lt;/QueueConnectionFactoryBindingName&gt;  

        &lt;QueueBindingName&gt;cms_dao_log&lt;/QueueBindingName&gt;  

    &lt;/appender&gt;  

    &lt;appender name="jms_service" class="ch.qos.logback.classic.net.JMSQueueAppender"&gt;  

        &lt;InitialContextFactoryName&gt;  

            org.apache.activemq.jndi.ActiveMQInitialContextFactory  
        &lt;/InitialContextFactoryName&gt;  

        &lt;ProviderURL&gt;tcp://192.168.1.120:61616&lt;/ProviderURL&gt;  

        &lt;filter class="ch.qos.logback.core.filter.EvaluatorFilter"&gt;  

            &lt;evaluator name="myEval_service"&gt;  

                &lt;expression&gt;message.contains("service.impl")&lt;/expression&gt;  

            &lt;/evaluator&gt;  

            &lt;onMatch&gt;ACCEPT&lt;/onMatch&gt;  

            &lt;onMismatch&gt;DENY&lt;/onMismatch&gt;  

        &lt;/filter&gt;  

        &lt;QueueConnectionFactoryBindingName&gt;ConnectionFactory  

        &lt;/QueueConnectionFactoryBindingName&gt;  

        &lt;QueueBindingName&gt;cms_service_log&lt;/QueueBindingName&gt;  

    &lt;/appender&gt;  

    &lt;logger name="com.cms5.cmsservice.jms"&gt;  

        &lt;level value="DEBUG" /&gt;  

    &lt;/logger&gt;  

    &lt;logger name="java.sql.PreparedStatement"&gt;  

        &lt;level value="DEBUG" /&gt;  

    &lt;/logger&gt;  

    &lt;logger name="java.sql.Connection"&gt;  

        &lt;level value="DEBUG" /&gt;  

    &lt;/logger&gt;  

    &lt;logger name="java.sql.Statement"&gt;  

        &lt;level value="DEBUG" /&gt;  

    &lt;/logger&gt;  

    &lt;logger name="com.ibatis"&gt;  

        &lt;level value="DEBUG" /&gt;  

    &lt;/logger&gt;  

    &lt;logger name="com.ibatis.common.jdbc.SimpleDataSource"&gt;  

        &lt;level value="DEBUG" /&gt;  

    &lt;/logger&gt;  

    &lt;logger name="com.ibatis.common.jdbc.ScriptRunner"&gt;  

        &lt;level value="DEBUG" /&gt;  

    &lt;/logger&gt;  

    &lt;logger name="com.ibatis.sqlmap.engine.impl.SqlMapClientDelegate"&gt;  

        &lt;level value="DEBUG" /&gt;  

    &lt;/logger&gt;  

    &lt;logger name="com.danga.MemCached"&gt;  

        &lt;level value="INFO" /&gt;  

    &lt;/logger&gt;  

    &lt;logger name="org.springframework.test"&gt;  

        &lt;level value="DEBUG" /&gt;  

    &lt;/logger&gt;  

    &lt;logger name="org.apache.struts2"&gt;  

        &lt;level value="DEBUG" /&gt;  

    &lt;/logger&gt;  

    &lt;root&gt;  

        &lt;level value="INFO" /&gt;  

        &lt;!--&lt;appender-ref ref="stdout" /&gt; 

        --&gt;  
        &lt;appender-ref ref="logfile-dao" /&gt;  

        &lt;appender-ref ref="logfile-service" /&gt;  

        &lt;appender-ref ref="jms_dao" /&gt;  

        &lt;appender-ref ref="jms_service" /&gt;  

    &lt;/root&gt;  

&lt;/configuration&gt;  


 
就先不做说明了，里面的配置还是比较明确的，关于jmsappender那部分，之前也做过简单说明。
 

